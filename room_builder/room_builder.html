<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Room Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* All our pure CSS styles are still here */
        body {
            font-family: 'Inter', sans-serif;
            --tw-bg-opacity: 1;
            background-color: rgb(243 244 246 / var(--tw-bg-opacity)); /* bg-gray-100 */
        }

        .form-section {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1rem;
        }

        .form-section-title {
            font-size: 1.5rem; /* 2xl */
            line-height: 2rem;
            font-weight: 600;
            color: rgb(31 41 55); /* text-gray-800 */
            border-bottom-width: 1px;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-label {
            display: block; /* This is the key fix! */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            font-weight: 500; /* font-medium */
            color: rgb(55 65 81); /* text-gray-700 */
            margin-bottom: 0.25rem;
        }

        .form-input, .form-textarea, .form-select {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-width: 1px;
            border-color: rgb(209 213 219); /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
            font-size: 0.875rem; /* sm:text-sm */
            line-height: 1.25rem;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: rgb(99 102 241); /* ring-indigo-500 */
            box-shadow: 0 0 0 2px var(--tw-ring-color);
            border-color: rgb(99 102 241); /* border-indigo-500 */
        }

        .form-textarea {
            min-height: 150px;
        }

        .form-checkbox {
            height: 1.25rem; /* h-5 */
            width: 1.25rem; /* w-5 */
            color: rgb(79 70 229); /* text-indigo-600 */
            border-color: rgb(209 213 219); /* border-gray-300 */
            border-radius: 0.25rem; /* rounded */
        }
        
        .form-checkbox:focus {
            --tw-ring-color: rgb(99 102 241); /* ring-indigo-500 */
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border: 1px solid transparent;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            font-weight: 500; /* font-medium */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
            color: #fff; /* text-white */
            cursor: pointer;
        }
        
        .btn:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-offset-shadow: 0 0 0 2px #fff;
            box-shadow: var(--tw-ring-offset-shadow), 0 0 0 2px var(--tw-ring-color);
        }

        .btn-primary {
            background-color: rgb(79 70 229); /* bg-indigo-600 */
            --tw-ring-color: rgb(99 102 241); /* focus:ring-indigo-500 */
        }
        .btn-primary:hover {
            background-color: rgb(67 56 202); /* hover:bg-indigo-700 */
        }

        .btn-secondary {
            background-color: rgb(22 163 74); /* bg-green-600 */
            --tw-ring-color: rgb(34 197 94); /* focus:ring-green-500 */
        }
        .btn-secondary:hover {
            background-color: rgb(21 128 61); /* hover:bg-green-700 */
        }

        .btn-danger {
            background-color: rgb(220 38 38); /* bg-red-600 */
            --tw-ring-color: rgb(239 68 68); /* focus:ring-red-500 */
        }
        .btn-danger:hover {
            background-color: rgb(185 28 28); /* hover:bg-red-700 */
        }

        .btn-small {
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem;
        }

        .dynamic-item {
            background-color: rgb(249 250 251); /* bg-gray-50 */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            border-width: 1px;
            border-color: rgb(229 231 235); /* border-gray-200 */
            margin-bottom: 0.75rem; /* mb-3 */
        }

        .dynamic-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .dynamic-item-title {
            font-size: 1rem; /* text-md */
            line-height: 1.5rem;
            font-weight: 600; /* font-semibold */
            color: rgb(55 65 81); /* text-gray-700 */
        }

        #message-box {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            z-index: 50;
            color: #fff;
            font-weight: 500;
        }
        
        #message-box.hidden {
            display: none;
        }

        #message-box.success {
            background-color: rgb(34 197 94); /* bg-green-500 */
        }

        #message-box.error {
            background-color: rgb(239 68 68); /* bg-red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 p-3 md:p-6">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">MUD Room Builder</h1>
        
        <form id="room-form">
            
            <div class="form-section">
                <h2 class="form-section-title">Core Details</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
                    <div>
                        <label for="name" class="form-label">Room Name</label>
                        <input type="text" id="name" class="form-input" placeholder="e.g., The Template Workshop" required>
                    </div>
                    <div>
                        <label for="room_id" class="form-label">Room ID (Unique)</label>
                        <input type="text" id="room_id" class="form-input" placeholder="e.g., template_workshop" required>
                    </div>

                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label for="x" class="form-label">X</label>
                        <input type="number" id="x" class="form-input" value="0">
                    </div>
                    <div>
                        <label for="y" class="form-label">Y</label>
                        <input type="number" id="y" class="form-input" value="0">
                    </div>
                    <div>
                        <label for="z" class="form-label">Z</label>
                        <input type="number" id="z" class="form-input" value="0">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"> <div>
                        <label for="interior_id" class="form-label">Interior ID</label>
                        <input type="text" id="interior_id" class="form-input" placeholder="e.g., builder_zone">
                    </div>
                    <div>
                        <label for="unabsorbed_social_exp" class="form-label">Unabsorbed Social EXP</label>
                        <input type="number" id="unabsorbed_social_exp" class="form-input" value="0">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="is_outdoor" class="form-label">Is Outdoor?</label>
                    <input type="checkbox" id="is_outdoor" class="form-checkbox mt-1">
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">Descriptions</h2>
                <div>
                    <label for="desc_default" class="form-label">Default Description</label>
                    <textarea id="desc_default" class="form-textarea" placeholder="The default appearance of the room." required></textarea>
                </div>
                <div class="mt-4">
                    <label for="desc_brief" class="form-label">BRIEF Description (Optional)</label>
                    <textarea id="desc_brief" class="form-textarea" style="min-height: 60px;" placeholder="A short, one-line description for BRIEF mode."></textarea>
                </div>
                <div class="mt-4">
                    <label for="desc_dawn" class="form-label">DAWN Description (Optional)</label>
                    <textarea id="desc_dawn" class="form-textarea" placeholder="Appearance at dawn."></textarea>
                </div>
                <div class="mt-4">
                    <label for="desc_storm" class="form-label">STORM Description (Optional)</label>
                    <textarea id="desc_storm" class="form-textarea" placeholder="Appearance during a storm."></textarea>
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">Exits</h2>
                <div id="exits-container">
                    </div>
                <button type="button" onclick="addExit()" class="btn btn-primary btn-small mt-2">Add Exit</button>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">Objects</h2>
                <div id="objects-container">
                    </div>
                <button type="button" onclick="addObject()" class="btn btn-primary btn-small mt-2">Add Object</button>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">Hidden Objects</h2>
                <div id="hidden-objects-container">
                    </div>
                <button type="button" onclick="addHiddenObject()" class="btn btn-primary btn-small mt-2">Add Hidden Object</button>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">Forageable Items</h2>
                <div id="forageable-items-container">
                    </div>
                <button type="button" onclick="addForageable()" class="btn btn-primary btn-small mt-2">Add Forageable Item</button>
            </div>

            <div class="form-section flex justify-end space-x-4">
                <button type="button" onclick="downloadJSON()" class="btn btn-secondary">Download JSON</button>
                <button type="submit" class="btn btn-primary">Save to Server</button>
            </div>

        </form>
    </div>

    <div id="message-box" class="hidden"></div>


    <script>
        // --- Helper Functions ---
        
        /**
         * Splits a comma-separated string into an array, trimming whitespace.
         * Returns an empty array if the string is empty.
         */
        function parseList(str) {
            if (!str) return [];
            return str.split(',').map(item => item.trim()).filter(item => item.length > 0);
        }

        /**
         * Removes the parent '.dynamic-item' of the clicked button.
         */
        function removeItem(button) {
            button.closest('.dynamic-item').remove();
        }

        /**
         * Shows a success or error message.
         */
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = type === 'success' ? 'success' : 'error';
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // --- Dynamic Element Adders ---

        function addExit() {
            const container = document.getElementById('exits-container');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
                <div class="dynamic-item-header">
                    <h3 class="dynamic-item-title">New Exit</h3>
                    <button type="button" onclick="removeItem(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Direction (e.g., north, out)</label>
                        <input type="text" class="form-input exit-direction" placeholder="out">
                    </div>
                    <div>
                        <label class="form-label">Target Room ID</label>
                        <input type="text" class="form-input exit-target" placeholder="void">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function addObject() {
            const container = document.getElementById('objects-container');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
                <div class="dynamic-item-header">
                    <h3 class="dynamic-item-title">New Object</h3>
                    <button type="button" onclick="removeItem(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input obj-name" placeholder="a sturdy door">
                    </div>
                    <div>
                        <label class="form-label">Keywords (comma-separated)</label>
                        <input type="text" class="form-input obj-keywords" placeholder="door, sturdy door">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea obj-description" placeholder="A simple door."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label class="form-label">Verbs (comma-separated)</label>
                        <input type="text" class="form-input obj-verbs" placeholder="look, examine, enter">
                    </div>
                    <div>
                        <label class="form-label">Perception DC</label>
                        <input type="number" class="form-input obj-perception_dc" value="0">
                    </div>
                    <div>
                        <label class="form-label">Target Room (for doors)</label>
                        <input type="text" class="form-input obj-target_room" placeholder="void">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="form-label">Is NPC?</label>
                        <input type="checkbox" class="form-checkbox obj-is_npc mt-1">
                    </div>
                    <div>
                        <label class="form-label">Is Monster?</label>
                        <input type="checkbox" class="form-checkbox obj-is_monster mt-1">
                    </div>
                </div>
                <div class="mt-4 p-3 bg-gray-100 rounded-md">
                    <h4 class="text-sm font-semibold mb-2 text-gray-600">NPC/Monster Details (Optional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div>
                            <label class="form-label">Monster ID</label>
                            <input type="text" class="form-input obj-monster_id" placeholder="practice_dummy_template">
                        </div>
                        <div>
                            <label class="form-label">Quest Giver IDs (comma-separated)</label>
                            <input type="text" class="form-input obj-quest_giver_ids">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="form-label">All Quests Done Message</label>
                        <input type="text" class="form-input obj-all_quests_done_message">
                    </div>
                    <div class="mt-4">
                        <label class="form-label">Shop Data (Enter as JSON)</label>
                        <textarea class="form-textarea font-mono text-sm obj-shop_data" placeholder='{ "type": "builder", "inventory": ["item1"] }'></textarea>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function addHiddenObject() {
            const container = document.getElementById('hidden-objects-container');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
                <div class="dynamic-item-header">
                    <h3 class="dynamic-item-title">New Hidden Object</h3>
                    <button type="button" onclick="removeItem(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input hobj-name" placeholder="a hidden schematic">
                    </div>
                    <div>
                        <label class="form-label">Item ID</label>
                        <input type="text" class="form-input hobj-item_id" placeholder="schematic_item">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea hobj-description" placeholder="A rolled-up schematic."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label class="form-label">Keywords (comma-separated)</label>
                        <input type="text" class="form-input hobj-keywords" placeholder="schematic, plans">
                    </div>
                    <div>
                        <label class="form-label">Verbs (comma-separated)</label>
                        <input type="text" class="form-input hobj-verbs" placeholder="GET, TAKE, LOOK">
                    </div>
                    <div>
                        <label class="form-label">Perception DC</label>
                        <input type="number" class="form-input hobj-perception_dc" value="25">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="form-label">Is Item?</label>
                    <input type="checkbox" class="form-checkbox hobj-is_item mt-1" checked>
                </div>
            `;
            container.appendChild(div);
        }
        
        function addForageable() {
            const container = document.getElementById('forageable-items-container');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
                <div class="dynamic-item-header">
                    <h3 class="dynamic-item-title">New Forageable Item</h3>
                    <button type="button" onclick="removeItem(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Item ID</label>
                        <input type="text" class="form-input forage-item_id" placeholder="viridian_leaf">
                    </div>
                    <div>
                        <label class="form-label">Item Name</label>
                        <input type="text" class="form-input forage-item_name" placeholder="viridian leaf">
                    </div>
                    <div>
                        <label class="form-label">DC</label>
                        <input type="number" class="form-input forage-dc" value="50">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        // --- Data Collection & Submission ---

        /**
         * Gathers all data from the form and constructs the JSON object.
         */
        function gatherData() {
            const room = {};

            // Core Details
            room.room_id = document.getElementById('room_id').value;
            room.name = document.getElementById('name').value;
            room.x = parseInt(document.getElementById('x').value) || 0;
            room.y = parseInt(document.getElementById('y').value) || 0;
            room.z = parseInt(document.getElementById('z').value) || 0;
            room.interior_id = document.getElementById('interior_id').value;
            room.is_outdoor = document.getElementById('is_outdoor').checked;
            room.unabsorbed_social_exp = parseInt(document.getElementById('unabsorbed_social_exp').value) || 0;

            // Descriptions
            room.description = {
                default: document.getElementById('desc_default').value
            };
            // ---
            // --- NEW: Add brief description
            // ---
            const descBrief = document.getElementById('desc_brief').value;
            if (descBrief) room.description.brief = descBrief;
            // ---
            // --- END NEW
            // ---
            const descDawn = document.getElementById('desc_dawn').value;
            if (descDawn) room.description.DAWN = descDawn;
            const descStorm = document.getElementById('desc_storm').value;
            if (descStorm) room.description.STORM = descStorm;

            // Exits
            room.exits = {};
            document.querySelectorAll('#exits-container .dynamic-item').forEach(item => {
                const direction = item.querySelector('.exit-direction').value;
                const target = item.querySelector('.exit-target').value;
                if (direction) {
                    room.exits[direction] = target;
                }
            });

            // Objects
            room.objects = [];
            document.querySelectorAll('#objects-container .dynamic-item').forEach(item => {
                const obj = {
                    name: item.querySelector('.obj-name').value,
                    description: item.querySelector('.obj-description').value,
                    verbs: parseList(item.querySelector('.obj-verbs').value),
                    perception_dc: parseInt(item.querySelector('.obj-perception_dc').value) || 0,
                    keywords: parseList(item.querySelector('.obj-keywords').value),
                    is_npc: item.querySelector('.obj-is_npc').checked,
                    is_monster: item.querySelector('.obj-is_monster').checked
                };
                
                const targetRoom = item.querySelector('.obj-target_room').value;
                if(targetRoom) obj.target_room = targetRoom;

                if (obj.is_monster) {
                    const monsterId = item.querySelector('.obj-monster_id').value;
                    if(monsterId) obj.monster_id = monsterId;
                } else {
                    obj.monster_id = null;
                }
                
                if (obj.is_npc) {
                    const questIds = parseList(item.querySelector('.obj-quest_giver_ids').value);
                    if(questIds.length > 0) obj.quest_giver_ids = questIds;
                    
                    const doneMsg = item.querySelector('.obj-all_quests_done_message').value;
                    if(doneMsg) obj.all_quests_done_message = doneMsg;
                    
                    const shopDataStr = item.querySelector('.obj-shop_data').value;
                    if (shopDataStr) {
                        try {
                            obj.shop_data = JSON.parse(shopDataStr);
                        } catch (e) {
                            console.warn("Invalid Shop Data JSON. Skipping.", e);
                            showMessage("Warning: Invalid JSON in Shop Data for one object.", "error");
                        }
                    }
                }
                
                if(obj.name) room.objects.push(obj);
            });

            // Hidden Objects
            room.hidden_objects = [];
            document.querySelectorAll('#hidden-objects-container .dynamic-item').forEach(item => {
                const hobj = {
                    name: item.querySelector('.hobj-name').value,
                    item_id: item.querySelector('.hobj-item_id').value,
                    description: item.querySelector('.hobj-description').value,
                    perception_dc: parseInt(item.querySelector('.hobj-perception_dc').value) || 0,
                    keywords: parseList(item.querySelector('.hobj-keywords').value),
                    verbs: parseList(item.querySelector('.hobj-verbs').value),
                    is_item: item.querySelector('.hobj-is_item').checked
                };
                if(hobj.name) room.hidden_objects.push(hobj);
            });

            // Forageable Items
            room.forageable_items = [];
            document.querySelectorAll('#forageable-items-container .dynamic-item').forEach(item => {
                const forage = {
                    item_id: item.querySelector('.forage-item_id').value,
                    item_name: item.querySelector('.forage-item_name').value,
                    dc: parseInt(item.querySelector('.forage-dc').value) || 0
                };
                if(forage.item_id) room.forageable_items.push(forage);
            });
            
            return room;
        }

        /**
         * Handles the main form submission.
         */
        async function handleSubmit(event) {
            event.preventDefault();
            const data = gatherData();
            
            // Basic validation
            if (!data.room_id || !data.name || !data.description.default) {
                showMessage("Room ID, Name, and Default Description are required.", "error");
                return;
            }

            try {
                const response = await fetch('/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`Success! Room saved as ${result.path}`, 'success');
                } else {
                    showMessage(`Error: ${result.error}`, 'error');
                }
            } catch (err) {
                console.error("Save error:", err);
                showMessage(`Network or server error: ${err.message}`, 'error');
            }
        }
        
        /**
         * Triggers a client-side download of the JSON file.
         */
        function downloadJSON() {
            const data = gatherData();
            
            if (!data.room_id) {
                showMessage("Please set a Room ID before downloading.", "error");
                return;
            }
            
            // Save as a list, just like the template
            const jsonData = JSON.stringify([data], null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.room_id}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage("JSON download started.", 'success');
        }

        // Attach submit listener to the form
        document.getElementById('room-form').addEventListener('submit', handleSubmit);
        
        // Load some default data to make testing easier
        window.onload = () => {
            document.getElementById('room_id').value = 'template_workshop';
            document.getElementById('name').value = 'The Template Workshop';
            document.getElementById('z').value = '100';
            document.getElementById('interior_id').value = 'builder_zone';
            document.getElementById('desc_default').value = "A clean, well-lit workshop. A workbench sits in the center, covered in tools. A helpful 'Builder' NPC stands nearby, and a practice dummy is in the corner. A sturdy 'Door' is the only way out.";
            
            // ---
            // --- NEW: Add default for brief
            // ---
            document.getElementById('desc_brief').value = "A clean workshop with a workbench, NPC, and dummy.";
            // ---
            // --- END NEW
            // ---
            
            document.getElementById('desc_dawn').value = 'The workshop is bathed in the soft, angled light of dawn.';
            document.getElementById('desc_storm').value = 'Rain lashes against the workshop windows, and the sound of thunder echoes faintly.';
            
            addExit();
            document.querySelector('.exit-direction').value = 'out';
            document.querySelector('.exit-target').value = 'void';
            
            // Add other defaults if you like
            console.log("MUD Room Builder UI loaded.");
        };

    </script>
</body>
</html>