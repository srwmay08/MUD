<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e5e5e5; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        
        #main-container { display: flex; height: 100vh; }
        #editor-panel { width: 450px; flex-shrink: 0; overflow-y: auto; padding: 1.5rem; border-right: 1px solid #333; background: #1e1e1e; display: flex; flex-direction: column; gap: 1.5rem; }
        #visual-panel { flex-grow: 1; display: flex; flex-direction: column; background: #0a0a0a; position: relative; }
        #map-container { flex-grow: 1; overflow: hidden; cursor: grab; position: relative; background-image: radial-gradient(#2a2a2a 1px, transparent 1px); background-size: 20px 20px; }
        #map-container:active { cursor: grabbing; }
        #map-content { transform-origin: 0 0; transition: transform 0.1s ease-out; }
        .map-room rect { fill: #333; stroke: #555; stroke-width: 1; transition: fill 0.1s; cursor: pointer; }
        .map-room:hover rect { fill: #444; stroke: #888; }
        .map-room.current rect { fill: #f59e0b; stroke: #fff; stroke-width: 2; }
        .map-room text { font-size: 8px; fill: #888; text-anchor: middle; pointer-events: none; font-family: monospace; user-select: none; }
        .map-room.current text { fill: #000; font-weight: bold; }
        .map-link { stroke: #444; stroke-width: 1; pointer-events: none; }
        .form-label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 0.2rem; font-weight: 600; text-transform: uppercase; }
        .form-input, .form-textarea, .form-select { width: 100%; background: #121212; border: 1px solid #333; color: #fff; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.9rem; transition: border-color 0.2s; font-family: monospace; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #f59e0b; }
        .dynamic-item { background: #252525; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #333; margin-bottom: 0.5rem; font-size: 0.85rem; }
        .btn { padding: 0.4rem 0.8rem; border-radius: 0.25rem; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { filter: brightness(1.1); }
        .btn-primary { background: #f59e0b; color: #000; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-secondary { background: #3b82f6; color: #fff; }
        .btn-neutral { background: #374151; color: #fff; border: 1px solid #4b5563; }
        .btn-success { background: #10b981; color: #fff; }
        #room-list-overlay { position: absolute; top: 10px; right: 10px; width: 220px; max-height: 400px; background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 0.5rem; overflow-y: auto; padding: 0.5rem; z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .room-list-item { padding: 6px 8px; cursor: pointer; font-size: 0.8rem; border-radius: 4px; color: #ccc; margin-bottom: 2px; }
        .room-list-item:hover { background: #333; color: #fff; }
        .room-list-item.active { background: #f59e0b; color: #000; font-weight: bold; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #1e1e1e; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #444; width: 400px; max-width: 95%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* Object Type Selector */
        .object-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px;}
        .obj-type-select { background: #333; color: #fff; font-size: 0.75rem; border: none; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="editor-panel">
        <div class="flex flex-col gap-2 mb-4 bg-black/20 p-3 rounded border border-white/5">
            <div class="flex justify-between items-center">
                <h1 class="text-lg font-bold text-amber-500">Room Architect</h1>
                <span id="unsaved-indicator" class="text-xs text-red-400 hidden">‚óè Unsaved</span>
            </div>
            <div class="grid grid-cols-5 gap-2">
                <button onclick="showLoadModal()" class="btn btn-neutral" title="Load Zone">üìÇ</button>
                <button onclick="showSaveModal()" class="btn btn-neutral" title="Save Zone">üíæ</button>
                <button onclick="deleteCurrentRoom()" class="btn btn-danger border border-red-800" title="Delete Room">‚úï</button>
                <button onclick="newZone()" class="btn btn-danger" title="New Zone">üóëÔ∏è All</button>
                <button onclick="createNewRoom()" class="btn btn-secondary" title="New Room">‚ûï</button>
            </div>
        </div>

        <form id="room-form" onsubmit="return false;">
            <div class="bg-black/20 p-3 rounded border border-white/5 mb-4">
                <div class="grid grid-cols-1 gap-2 mb-2">
                    <label class="form-label">ID</label>
                    <input type="text" id="room_id" class="form-input text-amber-500 font-bold" oninput="updateCurrentRoomState()">
                    <label class="form-label">Name</label>
                    <input type="text" id="name" class="form-input" oninput="updateCurrentRoomState()">
                </div>
                
                <div class="grid grid-cols-4 gap-2">
                    <div class="col-span-1"><label class="form-label">X</label><input type="number" id="x" class="form-input text-center" oninput="updateCurrentRoomState()"></div>
                    <div class="col-span-1"><label class="form-label">Y</label><input type="number" id="y" class="form-input text-center" oninput="updateCurrentRoomState()"></div>
                    <div class="col-span-1"><label class="form-label">Z</label><input type="number" id="z" class="form-input text-center" oninput="updateCurrentRoomState()"></div>
                    <div class="col-span-1"><label class="form-label">Zone</label><input type="text" id="interior_id" class="form-input text-center text-xs" oninput="updateCurrentRoomState()"></div>
                </div>
                <div class="mt-2 flex gap-2">
                     <label class="flex items-center gap-1 cursor-pointer">
                        <input type="checkbox" id="is_outdoor" class="accent-amber-500" onchange="updateCurrentRoomState()">
                        <span class="text-xs text-gray-400">Outdoor</span>
                    </label>
                </div>
            </div>

            <div class="bg-blue-900/10 border border-blue-900/30 p-3 rounded mb-4">
                <h2 class="text-xs font-bold text-blue-400 uppercase mb-2">Quick Build</h2>
                <div class="grid grid-cols-3 gap-1 text-xs">
                    <button class="btn btn-neutral h-8" onclick="quickBuild('northwest', -1, 1)">NW</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('north', 0, 1)">N</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('northeast', 1, 1)">NE</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('west', -1, 0)">W</button>
                    <button class="btn btn-primary h-8" onclick="centerMapOnActive()">Find</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('east', 1, 0)">E</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('southwest', -1, -1)">SW</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('south', 0, -1)">S</button>
                    <button class="btn btn-neutral h-8" onclick="quickBuild('southeast', 1, -1)">SE</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">Description</label>
                <textarea id="desc_default" class="form-textarea h-24" oninput="updateCurrentRoomState()"></textarea>
                <div class="text-[10px] text-gray-500 mt-1">Highlight text above and click 'Embed' on an object below.</div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="form-label">Exits</label>
                        <button type="button" onclick="addExitUI()" class="text-xs text-amber-500 hover:text-white">+ Add</button>
                    </div>
                    <div id="exits-container" class="space-y-1"></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="form-label">Objects</label>
                        <button type="button" onclick="addObjectUI()" class="text-xs text-amber-500 hover:text-white">+ Add</button>
                    </div>
                    <div id="objects-container" class="space-y-1"></div>
                </div>
            </div>
            
             <div class="flex justify-center mt-8 pb-10">
                <button type="button" onclick="downloadZoneJSON()" class="btn btn-secondary w-full">Download JSON</button>
            </div>
        </form>
    </div>

    <div id="visual-panel">
        <div id="room-list-overlay">
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Rooms</h3>
                <span id="list-count" class="text-xs text-gray-500">0</span>
            </div>
            <div id="room-list-content"></div>
        </div>

        <div id="map-container" onwheel="handleZoom(event)" onmousedown="startPan(event)">
            <svg id="map-svg" width="100%" height="100%">
                <g id="map-content">
                    <g id="map-links"></g>
                    <g id="map-nodes"></g>
                </g>
            </svg>
        </div>
        <div class="bg-black p-2 text-xs text-gray-500 flex justify-between border-t border-gray-800">
            <span id="status-filename" class="font-mono">Unsaved Zone</span>
            <span id="status-coords" class="font-mono text-amber-500"></span>
        </div>
    </div>
</div>

<div id="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div id="load-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-4">Load Zone</h2>
        <select id="server-file-list" class="form-select mb-4 text-sm h-64" size="10"></select>
        <div class="flex justify-end space-x-2"><button onclick="document.getElementById('modal-overlay').style.display='none'" class="btn btn-neutral">Cancel</button><button onclick="loadFromServer()" class="btn btn-primary">Load</button></div>
    </div>
    <div id="save-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-4">Save Zone</h2>
        <input type="text" id="save-filename" class="form-input mb-4 text-amber-500" placeholder="zones/new_zone.json">
        <div class="flex justify-end space-x-2"><button onclick="document.getElementById('modal-overlay').style.display='none'" class="btn btn-neutral">Cancel</button><button onclick="saveToServer()" class="btn btn-success">Save</button></div>
    </div>
</div>

<datalist id="dl-room-ids"></datalist>

<script>
    // --- Global State ---
    let zoneRooms = [];
    let activeRoomId = null;
    let gameAssets = { monsters: [], items: [], nodes: [], loot_tables: [] };
    let scale = 1, panX = 0, panY = 0, isPanning = false, startPanX = 0, startPanY = 0;

    // --- Init ---
    window.onload = async () => {
        const c = document.getElementById('map-container');
        panX = c.clientWidth / 2; panY = c.clientHeight / 2;
        updateMapTransform();
        await fetchAssets();
        if(zoneRooms.length === 0) createNewRoom("start_room", 0, 0, 0);
    };

    async function fetchAssets() {
        try {
            const res = await fetch('/api/assets');
            gameAssets = await res.json();
        } catch(e) { console.error("Failed to load assets", e); }
    }

    // --- Helpers ---
    function normalizeRoom(r) {
        r.x = parseInt(r.x)||0; r.y = parseInt(r.y)||0; r.z = parseInt(r.z)||0;
        r.room_id = String(r.room_id || `room_${Date.now()}`);
        r.name = String(r.name || "Unnamed");
        if(!r.description) r.description = {default:""};
        if(!r.exits) r.exits = {};
        if(!r.objects) r.objects = [];
        return r;
    }

    function getAssetOptions(type, selectedValue) {
        let options = `<option value="">-- Select ${type} --</option>`;
        const list = gameAssets[type === 'monster' ? 'monsters' : (type === 'node' ? 'nodes' : 'items')] || [];
        list.forEach(asset => {
            const isSel = asset.id === selectedValue ? 'selected' : '';
            options += `<option value="${asset.id}" ${isSel}>${asset.name} (${asset.id})</option>`;
        });
        return options;
    }

    function renderObjectInputs(type, data) {
        // Common Hidden Checkbox
        const hiddenCheck = `
            <label class="flex items-center gap-1 mt-1 mb-2">
                <input type="checkbox" class="obj-hidden accent-red-500" ${data.hidden ? 'checked' : ''} onchange="updateCurrentRoomState()">
                <span class="text-[10px] text-gray-400">Hidden from List</span>
            </label>
        `;

        let html = '';
        if (type === 'static') {
            html += `
                <input class="form-input obj-name mb-1" value="${data.name||''}" placeholder="Name (e.g. tall statue)" oninput="updateCurrentRoomState()">
                <textarea class="form-textarea obj-desc mb-1 h-16 text-xs" placeholder="Description" oninput="updateCurrentRoomState()">${data.description||''}</textarea>
                <input class="form-input obj-keys text-xs" value="${(data.keywords||[]).join(',')}" placeholder="Keywords (comma sep)" oninput="updateCurrentRoomState()">
                <input class="form-input obj-verbs text-xs mt-1" value="${(data.verbs||['look']).join(',')}" placeholder="Verbs (e.g. look, push)" oninput="updateCurrentRoomState()">
            `;
        } else if (type === 'monster') {
            html += `
                <select class="form-select obj-ref-id text-amber-500" onchange="updateCurrentRoomState()">${getAssetOptions('monster', data.monster_id)}</select>
                <div class="text-[10px] text-gray-500 mt-1">Refers to data/monsters.json</div>
            `;
        } else if (type === 'item') {
            html += `
                <select class="form-select obj-ref-id text-green-500" onchange="updateCurrentRoomState()">${getAssetOptions('item', data.item_id)}</select>
                <div class="text-[10px] text-gray-500 mt-1">Refers to data/items/*.json</div>
            `;
        } else if (type === 'node') {
            html += `
                <select class="form-select obj-ref-id text-blue-500" onchange="updateCurrentRoomState()">${getAssetOptions('node', data.node_id)}</select>
                <div class="text-[10px] text-gray-500 mt-1">Refers to data/nodes.json</div>
            `;
        } else if (type === 'portal') {
             html += `
                <input class="form-input obj-name mb-1" value="${data.name||''}" placeholder="Name (e.g. iron gate)" oninput="updateCurrentRoomState()">
                <input class="form-input obj-target mb-1 text-amber-500" list="dl-room-ids" value="${data.target_room||''}" placeholder="Target Room ID" oninput="updateCurrentRoomState()">
                <input class="form-input obj-verbs text-xs" value="${(data.verbs||['ENTER']).join(',')}" placeholder="Verbs (e.g. ENTER, CLIMB)" oninput="updateCurrentRoomState()">
            `;
        }
        return html + hiddenCheck;
    }

    function detectObjectType(obj) {
        if (obj.monster_id) return 'monster';
        if (obj.item_id) return 'item';
        if (obj.node_id) return 'node';
        if (obj.target_room) return 'portal';
        return 'static';
    }

    function addObjectUI(obj={}) {
        const type = detectObjectType(obj);
        const div = document.createElement('div');
        div.className = 'dynamic-item object-item';
        
        div.innerHTML = `
            <div class="object-header">
                <div class="flex items-center gap-1">
                    <select class="obj-type-select" onchange="changeObjType(this)">
                        <option value="static" ${type==='static'?'selected':''}>Static</option>
                        <option value="monster" ${type==='monster'?'selected':''}>Monster</option>
                        <option value="item" ${type==='item'?'selected':''}>Item</option>
                        <option value="node" ${type==='node'?'selected':''}>Node</option>
                        <option value="portal" ${type==='portal'?'selected':''}>Portal</option>
                    </select>
                    <button onclick="embedObject(this)" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-2 py-1 rounded" title="Wrap selection in description with this object's link">Embed</button>
                </div>
                <button onclick="this.closest('.object-item').remove();updateCurrentRoomState()" class="text-red-500 font-bold ml-2">√ó</button>
            </div>
            <div class="obj-content">
                ${renderObjectInputs(type, obj)}
            </div>
        `;
        document.getElementById('objects-container').appendChild(div);
    }

    window.changeObjType = function(selectElem) {
        const type = selectElem.value;
        const contentDiv = selectElem.closest('.object-item').querySelector('.obj-content');
        contentDiv.innerHTML = renderObjectInputs(type, {});
        updateCurrentRoomState();
    }

    window.embedObject = function(btn) {
        const objDiv = btn.closest('.object-item');
        const type = objDiv.querySelector('.obj-type-select').value;
        let name = "", verbs = "look";

        if (type === 'static' || type === 'portal') {
            name = objDiv.querySelector('.obj-name').value;
            verbs = objDiv.querySelector('.obj-verbs').value;
        } else {
            const refId = objDiv.querySelector('.obj-ref-id').value;
            let list = [];
            if(type === 'monster') { list = gameAssets.monsters; verbs = "look,attack,talk"; }
            else if(type === 'item') { list = gameAssets.items; verbs = "get,look,examine"; }
            else if(type === 'node') { list = gameAssets.nodes; verbs = "look,harvest,mine"; }
            
            const asset = list.find(a => a.id === refId);
            name = asset ? asset.name : refId;
        }

        if (!name) return alert("Object name required for embedding.");

        const descArea = document.getElementById('desc_default');
        const start = descArea.selectionStart;
        const end = descArea.selectionEnd;
        const text = descArea.value;
        
        // If text is selected, use that as the display text, but link to the object name
        const selectedText = start !== end ? text.substring(start, end) : name;
        const span = `<span class="keyword" data-name="${name}" data-verbs="${verbs}">${selectedText}</span>`;
        
        descArea.value = text.substring(0, start) + span + text.substring(end);
        
        // Auto-check "Hidden" if we embed it, assuming user wants it in desc only
        const hiddenCheck = objDiv.querySelector('.obj-hidden');
        if(hiddenCheck && !hiddenCheck.checked) {
            hiddenCheck.checked = true;
        }
        
        updateCurrentRoomState();
    }

    function updateCurrentRoomState() {
        document.getElementById('unsaved-indicator').classList.remove('hidden');
        if(!activeRoomId) return;
        const r = zoneRooms.find(rm => rm.room_id === activeRoomId);
        if(!r) return;

        const formId = document.getElementById('room_id').value;
        if(formId && formId !== activeRoomId) { r.room_id = formId; activeRoomId = formId; }

        r.name = document.getElementById('name').value;
        r.x = parseInt(document.getElementById('x').value)||0;
        r.y = parseInt(document.getElementById('y').value)||0;
        r.z = parseInt(document.getElementById('z').value)||0;
        r.interior_id = document.getElementById('interior_id').value.trim();
        r.is_outdoor = document.getElementById('is_outdoor').checked;
        r.description.default = document.getElementById('desc_default').value;

        // Exits
        r.exits = {};
        document.querySelectorAll('.exit-item').forEach(el => {
            const d = el.querySelector('.exit-dir').value.trim().toLowerCase();
            const t = el.querySelector('.exit-target').value.trim();
            if(d && t) r.exits[d] = t;
        });

        // Objects
        r.objects = [];
        document.querySelectorAll('.object-item').forEach(el => {
            const type = el.querySelector('.obj-type-select').value;
            const hidden = el.querySelector('.obj-hidden').checked;
            let newObj = { hidden: hidden };

            if (type === 'static') {
                newObj.name = el.querySelector('.obj-name').value;
                newObj.description = el.querySelector('.obj-desc').value;
                newObj.keywords = el.querySelector('.obj-keys').value.split(',').map(s=>s.trim()).filter(s=>s);
                newObj.verbs = el.querySelector('.obj-verbs').value.split(',').map(s=>s.trim()).filter(s=>s);
            } else if (type === 'monster') {
                newObj.monster_id = el.querySelector('.obj-ref-id').value;
                newObj.is_monster = true;
            } else if (type === 'item') {
                newObj.item_id = el.querySelector('.obj-ref-id').value;
                newObj.is_item = true;
            } else if (type === 'node') {
                newObj.node_id = el.querySelector('.obj-ref-id').value;
                newObj.is_gathering_node = true;
            } else if (type === 'portal') {
                newObj.name = el.querySelector('.obj-name').value;
                newObj.target_room = el.querySelector('.obj-target').value;
                newObj.verbs = el.querySelector('.obj-verbs').value.split(',').map(s=>s.trim()).filter(s=>s);
            }

            if (newObj.name || newObj.monster_id || newObj.item_id || newObj.node_id) {
                r.objects.push(newObj);
            }
        });

        renderMap(); renderRoomList(); updateStatus();
    }

    // --- (Standard Logic) ---
    function createNewRoom(id=null, x=0, y=0, z=0) {
        const newId = id || `room_${Date.now()}`;
        const newRoom = { room_id: newId, name: "New Room", x, y, z, interior_id: "", description: { default: "" }, exits: {}, objects: [] };
        zoneRooms.push(normalizeRoom(newRoom));
        loadRoomIntoEditor(newId);
    }

    function loadRoomIntoEditor(id) {
        activeRoomId = id;
        const r = zoneRooms.find(rm => rm.room_id === id);
        if (!r) return;
        document.getElementById('room_id').value = r.room_id;
        document.getElementById('name').value = r.name;
        document.getElementById('x').value = r.x;
        document.getElementById('y').value = r.y;
        document.getElementById('z').value = r.z;
        document.getElementById('interior_id').value = r.interior_id || "";
        document.getElementById('is_outdoor').checked = !!r.is_outdoor;
        document.getElementById('desc_default').value = r.description.default || "";
        
        const exDiv = document.getElementById('exits-container'); exDiv.innerHTML = '';
        Object.entries(r.exits).forEach(([k,v]) => addExitUI(k,v));
        
        const obDiv = document.getElementById('objects-container'); obDiv.innerHTML = '';
        r.objects.forEach(o => addObjectUI(o)); 
        
        renderRoomList(); renderMap(); updateStatus();
    }

    function deleteCurrentRoom() {
        if (!activeRoomId) return;
        if (!confirm("Delete room?")) return;
        zoneRooms = zoneRooms.filter(r => r.room_id !== activeRoomId);
        zoneRooms.forEach(r => {
            for(let d in r.exits) if(r.exits[d]===activeRoomId) delete r.exits[d];
        });
        if(zoneRooms.length) loadRoomIntoEditor(zoneRooms[zoneRooms.length-1].room_id);
        else createNewRoom();
    }

    function addExitUI(d='', t='') {
        const div = document.createElement('div'); div.className = 'dynamic-item exit-item flex gap-1 items-center';
        div.innerHTML = `<input class="form-input exit-dir w-16" value="${d}" placeholder="Dir" oninput="updateCurrentRoomState()"><input class="form-input exit-target flex-1" value="${t}" placeholder="Target ID" oninput="updateCurrentRoomState()"><button onclick="this.parentElement.remove();updateCurrentRoomState()" class="text-red-500 font-bold px-2">√ó</button>`;
        document.getElementById('exits-container').appendChild(div);
    }

    function quickBuild(dir, dx, dy) {
        if(!activeRoomId) return;
        const cur = zoneRooms.find(r => r.room_id === activeRoomId);
        const nx = (parseInt(cur.x)||0) + dx;
        const ny = (parseInt(cur.y)||0) + dy;
        const nz = (parseInt(cur.z)||0);
        const zone = cur.interior_id || "";
        const exist = zoneRooms.find(r => r.x===nx && r.y===ny && r.z===nz && (r.interior_id||"")===zone);
        const backMap = {'north':'south','south':'north','east':'west','west':'east','northeast':'southwest','southwest':'northeast','northwest':'southeast','southeast':'northwest'};
        const backDir = backMap[dir.toLowerCase()];

        if(exist) {
            addExitUI(dir, exist.room_id);
            updateCurrentRoomState();
            if(backDir && !exist.exits[backDir]) exist.exits[backDir] = cur.room_id;
        } else {
            const nid = `room_${nx}_${ny}_${nz}`;
            addExitUI(dir, nid);
            updateCurrentRoomState();
            const newR = { room_id: nid, name: "New Room", x: nx, y: ny, z: nz, interior_id: zone, description:{default:""}, exits:{}, objects:[] };
            if(backDir) newR.exits[backDir] = cur.room_id;
            zoneRooms.push(normalizeRoom(newR));
            loadRoomIntoEditor(nid);
        }
    }

    function renderMap() {
        const ng = document.getElementById('map-nodes');
        const lg = document.getElementById('map-links');
        ng.innerHTML = ''; lg.innerHTML = '';
        const CELL = 30, GAP = 15, UNIT = CELL+GAP;
        const active = zoneRooms.find(r => r.room_id === activeRoomId);
        if (!active) return;
        const showZ = parseInt(active.z);
        const showZone = (active.interior_id||"").trim();
        const roomCoords = {};
        
        zoneRooms.forEach(r => {
            if(parseInt(r.z) !== showZ || (r.interior_id||"").trim() !== showZone) return;
            const rx = r.x * UNIT; const ry = -r.y * UNIT;
            roomCoords[r.room_id] = { x: rx + CELL/2, y: ry + CELL/2 };
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", `map-room ${r.room_id === activeRoomId ? 'current' : ''}`);
            g.onclick = () => loadRoomIntoEditor(r.room_id);
            g.innerHTML = `<rect x="${rx}" y="${ry}" width="${CELL}" height="${CELL}" rx="4"></rect><text x="${rx+CELL/2}" y="${ry+CELL/2+3}">${r.room_id.substring(0,3)}</text>`;
            ng.appendChild(g);
        });
        
        zoneRooms.forEach(r => {
            const start = roomCoords[r.room_id];
            if(!start) return;
            for(let d in r.exits) {
                const end = roomCoords[r.exits[d]];
                if(end) {
                    const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    l.setAttribute("x1", start.x); l.setAttribute("y1", start.y); l.setAttribute("x2", end.x); l.setAttribute("y2", end.y);
                    l.setAttribute("class", "map-link");
                    lg.appendChild(l);
                }
            }
        });
    }

    function updateMapTransform() { document.getElementById('map-content').setAttribute('transform', `translate(${panX}, ${panY}) scale(${scale})`); }
    function handleZoom(e) { e.preventDefault(); scale = Math.min(Math.max(0.1, scale + (e.deltaY * -0.001)), 5); updateMapTransform(); }
    function startPan(e) { isPanning=true; startPanX=e.clientX-panX; startPanY=e.clientY-panY; document.addEventListener('mousemove', doPan); document.addEventListener('mouseup', endPan); }
    function doPan(e) { if(!isPanning) return; panX=e.clientX-startPanX; panY=e.clientY-startPanY; updateMapTransform(); }
    function endPan() { isPanning=false; document.removeEventListener('mousemove', doPan); document.removeEventListener('mouseup', endPan); }
    function centerMapOnActive() { if(!activeRoomId) return; renderMap(); }

    async function showLoadModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.remove('hidden');
        document.getElementById('save-modal').classList.add('hidden');
        try {
            const res = await fetch('/api/zones');
            const files = await res.json();
            const s = document.getElementById('server-file-list'); s.innerHTML = '';
            files.forEach(f => s.innerHTML += `<option value="${f}">${f}</option>`);
        } catch(e) { alert(e); }
    }
    async function loadFromServer() {
        const f = document.getElementById('server-file-list').value;
        if(!f) return;
        const res = await fetch(`/api/load?file=${encodeURIComponent(f)}`);
        const data = await res.json();
        zoneRooms = data.map(normalizeRoom);
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('status-filename').innerText = f;
        if(zoneRooms.length) loadRoomIntoEditor(zoneRooms[0].room_id);
    }
    function showSaveModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('save-modal').classList.remove('hidden');
        document.getElementById('load-modal').classList.add('hidden');
    }
    async function saveToServer() {
        const f = document.getElementById('save-filename').value;
        if(!f) return alert("Filename required");
        await fetch('/api/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:f, rooms:zoneRooms}) });
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('unsaved-indicator').classList.add('hidden');
        document.getElementById('status-filename').innerText = f;
        alert("Saved!");
    }
    function newZone() { if(confirm("New Zone?")) { zoneRooms=[]; createNewRoom(); document.getElementById('status-filename').innerText = "Unsaved Zone"; } }
    
    function renderRoomList() {
        const c = document.getElementById('room-list-content'); c.innerHTML = '';
        document.getElementById('list-count').innerText = zoneRooms.length;
        const dataList = document.getElementById('dl-room-ids');
        dataList.innerHTML = '';
        zoneRooms.forEach(r => {
            const div = document.createElement('div');
            div.className = `room-list-item ${r.room_id===activeRoomId ? 'active' : ''}`;
            div.innerText = `${r.room_id} (${r.x}, ${r.y})`;
            div.onclick = () => loadRoomIntoEditor(r.room_id);
            c.appendChild(div);
            const opt = document.createElement('option');
            opt.value = r.room_id; opt.innerText = r.name; 
            dataList.appendChild(opt);
        });
    }

    function updateStatus() {
        const r = zoneRooms.find(rm => rm.room_id === activeRoomId);
        if(r) document.getElementById('status-coords').innerText = `X:${r.x} Y:${r.y} Z:${r.z}`;
    }
    function downloadZoneJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(zoneRooms, null, 2));
        const a = document.createElement('a'); a.href = dataStr; a.download = "zone.json"; document.body.appendChild(a); a.click(); a.remove();
    }
</script>
</body>
</html>