<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e5e5e5; height: 100vh; overflow: hidden; }
        
        #main-container { display: flex; height: 100vh; }
        #editor-panel { width: 440px; flex-shrink: 0; overflow-y: auto; padding: 1rem; border-right: 1px solid #333; background: #1a1a1a; display: flex; flex-direction: column; gap: 1rem; }
        #visual-panel { flex-grow: 1; display: flex; flex-direction: column; background: #0f0f0f; position: relative; }
        
        /* Map Canvas */
        #map-container { flex-grow: 1; overflow: hidden; cursor: grab; position: relative; 
                         background-image: radial-gradient(#2a2a2a 1px, transparent 1px); background-size: 20px 20px; }
        #map-container:active { cursor: grabbing; }
        #map-content { transform-origin: 0 0; transition: transform 0.1s ease-out; }
        
        /* Room Nodes */
        .map-room rect { fill: #333; stroke: #555; stroke-width: 1; transition: fill 0.1s; cursor: pointer; }
        .map-room:hover rect { fill: #444; stroke: #888; }
        .map-room.current rect { fill: #f59e0b; stroke: #fff; stroke-width: 2; }
        .map-room text { font-size: 8px; fill: #aaa; text-anchor: middle; pointer-events: none; font-family: monospace; user-select: none; }
        
        /* Links */
        .map-link { stroke: #555; stroke-width: 1; pointer-events: none; marker-end: url(#arrowhead); }
        .map-link.cross-zone { stroke: #3b82f6; stroke-width: 2; stroke-dasharray: 4; marker-end: url(#arrowhead-blue); }

        /* Zone Groups */
        .zone-group rect.zone-bg { fill: rgba(50, 50, 50, 0.05); stroke: #444; stroke-width: 1; stroke-dasharray: 4; rx: 8; }
        .zone-group text.zone-label { fill: #555; font-size: 12px; font-weight: bold; opacity: 0.5; pointer-events: none; }
        .zone-group:hover rect.zone-bg { stroke: #666; fill: rgba(60, 60, 60, 0.1); cursor: move; }
        
        /* UI Elements */
        .form-label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 0.2rem; font-weight: 600; text-transform: uppercase; }
        .form-input, .form-textarea, .form-select { width: 100%; background: #222; border: 1px solid #333; color: #fff; padding: 0.4rem; border-radius: 0.25rem; font-size: 0.85rem; font-family: monospace; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #f59e0b; }
        
        .btn { padding: 0.3rem 0.6rem; border-radius: 0.25rem; font-weight: 600; font-size: 0.75rem; cursor: pointer; transition: all 0.1s; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-primary { background: #f59e0b; color: #000; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-neutral { background: #374151; color: #fff; border: 1px solid #4b5563; }
        .btn-success { background: #10b981; color: #fff; }

        /* Collapsible Sections */
        details { border: 1px solid #333; border-radius: 4px; overflow: hidden; background: #222; }
        details summary { padding: 0.5rem; background: #2a2a2a; cursor: pointer; font-size: 0.75rem; font-weight: bold; user-select: none; }
        details summary:hover { background: #333; }
        details[open] summary { border-bottom: 1px solid #333; }
        .details-content { padding: 0.5rem; }

        /* Custom Checkbox Grid */
        .flag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .flag-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #ccc; }
        .flag-item input { accent-color: #f59e0b; }

        /* Object & Interaction Cards */
        .object-card { background: #252525; border: 1px solid #444; border-radius: 4px; padding: 6px; margin-bottom: 6px; position: relative; }
        .object-card.hidden-obj { border-color: #f59e0b; background: #2a2010; }
        .interaction-row { display: flex; gap: 4px; margin-top: 4px; background: #1a1a1a; padding: 4px; border-radius: 3px; border: 1px solid #333; align-items: center; }

        /* Context Menu */
        #context-menu { position: absolute; display: none; background: #222; border: 1px solid #444; border-radius: 4px; z-index: 100; min-width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .ctx-item { padding: 8px 12px; cursor: pointer; font-size: 0.8rem; color: #ccc; }
        .ctx-item:hover { background: #3b82f6; color: white; }
        .ctx-divider { height: 1px; background: #333; margin: 4px 0; }

        /* Zone List Overlay */
        #zone-list { 
            position: absolute; top: 10px; left: 10px; 
            background: rgba(20,20,20,0.95); 
            border: 1px solid #333; 
            padding: 8px; 
            border-radius: 6px; 
            max-height: 50vh;
            width: 280px; 
            display: flex; flex-direction: column;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        #loaded-files-container {
            overflow-y: auto; 
            flex-grow: 1; 
            margin-top: 4px;
            margin-bottom: 8px;
            padding-right: 4px;
        }
        /* Scrollbar styling */
        #loaded-files-container::-webkit-scrollbar { width: 6px; }
        #loaded-files-container::-webkit-scrollbar-track { background: #1a1a1a; }
        #loaded-files-container::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        #loaded-files-container::-webkit-scrollbar-thumb:hover { background: #555; }

        .zone-entry { 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; 
            padding: 6px;
            background: rgba(255,255,255,0.03); 
            border: 1px solid transparent;
            border-radius: 4px;
            margin-bottom: 4px;
            transition: all 0.1s;
        }
        .zone-entry:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: rgba(255,255,255,0.1);
        }
        .zone-name { 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
            flex: 1; 
            margin-right: 8px; 
            color: #ddd; 
            cursor: pointer;
            font-weight: 500;
        }
        .zone-name:hover { color: #f59e0b; text-decoration: underline; }
        
        .zone-actions { display: flex; align-items: center; gap: 4px; }
        .zone-count { font-size: 0.65rem; color: #666; font-family: monospace; min-width: 20px; text-align: right; }
        
        .zone-btn { 
            display: flex; align-items: center; justify-content: center;
            width: 22px; height: 22px;
            border-radius: 3px;
            color: #888;
            background: #2a2a2a;
            border: 1px solid #444;
            transition: all 0.1s;
            cursor: pointer;
        }
        .zone-btn:hover { background: #444; color: white; border-color: #666; }
        .zone-btn.save:hover { background: #065f46; color: #34d399; border-color: #10b981; }
        .zone-btn.close:hover { background: #7f1d1d; color: #fca5a5; border-color: #ef4444; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: #1e1e1e; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #444; width: 400px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }

        /* Toast Notification for Cycle */
        #toast-notification {
            position: absolute;
            bottom: 4rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #555;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            z-index: 100;
        }

        /* Z-Toggle Styles */
        .z-toggle-btn {
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #888;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
            min-width: 24px;
            text-align: center;
        }
        .z-toggle-btn:hover { background-color: #333; color: white; }
        .z-toggle-btn.active { background-color: #f59e0b; color: black; border-color: #f59e0b; font-weight: bold; }
        .z-toggle-btn.z-under { border-color: #9b59b6; }
        .z-toggle-btn.z-over { border-color: #2ecc71; }
        .z-toggle-btn.active.z-under { background-color: #9b59b6; border-color: #8e44ad; color: white; }
        .z-toggle-btn.active.z-over { background-color: #2ecc71; border-color: #27ae60; color: black; }

    </style>
</head>
<body>

<div id="main-container">
    <div id="editor-panel">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
            <h1 class="text-amber-500 font-bold">Room Architect</h1>
            <div class="flex gap-2">
                <button onclick="openLoadModal()" class="btn btn-neutral">Load Zone</button>
                <button onclick="saveAllZones()" class="btn btn-success">Save All</button>
            </div>
        </div>

        <form id="room-form" onsubmit="return false;">
            <div id="no-selection" class="text-gray-500 text-center text-sm py-10">Select a room to edit</div>
            
            <div id="room-editor" class="hidden space-y-4">
                <div class="bg-black/20 p-3 rounded border border-white/5">
                    <div class="grid grid-cols-1 gap-2 mb-2">
                        <div>
                            <label class="form-label">Room ID</label>
                            <input type="text" id="room_id" class="form-input text-amber-500 font-bold" oninput="updateRoomData()">
                        </div>
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" id="name" class="form-input" oninput="updateRoomData()">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="form-label">X</label><input type="number" id="x" class="form-input text-center" oninput="updateRoomData()"></div>
                        <div><label class="form-label">Y</label><input type="number" id="y" class="form-input text-center" oninput="updateRoomData()"></div>
                        <div><label class="form-label">Z</label><input type="number" id="z" class="form-input text-center" oninput="updateRoomData(); checkZChange();"></div>
                    </div>
                    <div class="mt-2 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <div id="file-badge" class="text-[10px] bg-blue-900/30 text-blue-400 px-2 py-1 rounded truncate max-w-[150px] cursor-pointer hover:bg-blue-800" onclick="openMoveModal()" title="Click to Move Room"></div>
                            
                            <div class="flex gap-3">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="is_outdoor" class="accent-amber-500" onchange="updateRoomData()">
                                    <span class="text-xs text-gray-400">Outdoor</span>
                                </label>
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="is_table" class="accent-amber-500" onchange="updateRoomData()">
                                    <span class="text-xs text-gray-400">Is Table</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="form-label w-16">Light</label>
                            <input type="range" id="illumination" min="0" max="100" class="flex-1 accent-amber-500" oninput="updateIlluminationDisplay(); updateRoomData()">
                            <span id="illumination-val" class="text-xs font-mono w-6 text-right text-gray-400">50</span>
                        </div>
                    </div>
                </div>

                <details>
                    <summary>Room Flags & Rules</summary>
                    <div class="details-content flag-grid" id="flags-container">
                        </div>
                </details>

                <details>
                    <summary>Ambient Events</summary>
                    <div class="details-content">
                        <div id="ambient-list" class="space-y-2 mb-2"></div>
                        <button onclick="addAmbientRow()" class="text-xs text-blue-400 hover:text-white">+ Add Event</button>
                    </div>
                </details>

                <div class="bg-blue-900/10 border border-blue-900/30 p-2 rounded">
                    <h2 class="text-[10px] font-bold text-blue-400 uppercase mb-1">Quick Build</h2>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <button class="btn btn-neutral h-6" onclick="quickBuild('northwest', -1, 1)">NW</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('north', 0, 1)">N</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('northeast', 1, 1)">NE</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('west', -1, 0)">W</button>
                        <button class="btn btn-neutral h-6 bg-blue-600 text-white" onclick="quickBuild('up', 0, 0, 1)">▲ Up</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('east', 1, 0)">E</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('southwest', -1, -1)">SW</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('south', 0, -1)">S</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('southeast', 1, -1)">SE</button>
                        <button class="btn btn-neutral h-6 col-start-2" onclick="quickBuild('down', 0, 0, -1)">▼ Dn</button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Description</label>
                    <textarea id="desc" class="form-textarea h-24" oninput="updateRoomData()"></textarea>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-1"><label class="form-label">Exits</label><button onclick="addExitRow()" class="text-xs text-green-400 hover:text-white">+ Add</button></div>
                    <div id="exits-list" class="space-y-1"></div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1"><label class="form-label">Objects</label><button onclick="addObjectRow()" class="text-xs text-green-400 hover:text-white">+ Add</button></div>
                    <div id="objects-list"></div>
                </div>

                <div>
                    <label class="form-label">JSON Preview</label>
                    <textarea id="json-preview" class="form-textarea h-48 text-[10px] font-mono text-green-400 bg-black/50" readonly></textarea>
                </div>
                
                <button onclick="deleteRoom()" class="btn btn-danger w-full mt-4">Delete Room</button>
            </div>
        </form>
    </div>

    <div id="visual-panel">
        <div id="zone-list">
            <div class="text-[10px] uppercase font-bold text-gray-500 border-b border-gray-700 mb-1 pb-1 flex justify-between items-center">
                <span>Loaded Zones</span>
                <span class="text-[9px] text-gray-600 cursor-pointer" onclick="updateFileList()">↻</span>
            </div>
            <div id="loaded-files-container"></div>
            <button onclick="openNewZoneModal()" class="btn btn-neutral w-full mt-1 text-[10px] py-1 border-dashed text-blue-400 hover:text-white hover:border-blue-500">+ New Zone File</button>
        </div>

        <div class="absolute top-2 right-2 flex gap-1 z-10 items-center">
            <label class="btn btn-neutral text-xs flex items-center gap-1 cursor-pointer">
                <input type="checkbox" id="show-tables-toggle" checked onchange="renderMap()" class="accent-amber-500 w-3 h-3">
                Tables
            </label>
            <div class="w-[1px] h-6 bg-gray-600 mx-1"></div>
            <button class="btn btn-neutral text-xs" id="btn-2d" onclick="setIsoMode(false)">2D</button>
            <button class="btn btn-neutral text-xs" id="btn-3d" onclick="setIsoMode(true)">3D</button>
        </div>
        
        <div class="absolute bottom-2 right-2 z-10 bg-black/80 border border-gray-700 rounded p-2 flex flex-col gap-1 shadow-lg">
             <div class="text-[10px] text-gray-400 font-bold uppercase mb-1">Visible Z-Levels</div>
             <div id="z-toggles-container" class="flex flex-wrap gap-1 max-w-[200px] justify-end">
                 <span class="text-[9px] text-gray-500 italic">No rooms loaded</span>
             </div>
        </div>

        <div id="map-container" onmousedown="startPan(event)" onwheel="handleZoom(event)" oncontextmenu="return false;">
            <svg id="map-svg" width="100%" height="100%">
                <defs>
                    <marker id="arrowhead" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto">
                        <polygon points="0 0, 5 2.5, 0 5" fill="#555"/>
                    </marker>
                    <marker id="arrowhead-blue" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto">
                        <polygon points="0 0, 5 2.5, 0 5" fill="#3b82f6"/>
                    </marker>
                </defs>
                <g id="map-content"></g>
            </svg>
        </div>
        
        <div id="toast-notification"></div>
    </div>
</div>

<div id="context-menu">
    <div class="ctx-item" onclick="actionConnect()">Connect to...</div>
    <div class="ctx-item" onclick="openMoveModal()">Move to Zone...</div>
    <div class="ctx-item" onclick="actionAddInterior()">Add Building/Interior</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item text-red-400" onclick="deleteRoom()">Delete Room</div>
</div>

<div id="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div id="load-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-4">Load Zone File</h2>
        <div class="text-xs text-gray-400 mb-2">Hold Ctrl/Cmd or Shift to select multiple.</div>
        <select id="server-file-list" class="form-select mb-4 text-sm h-64" size="10" multiple></select>
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="btn btn-neutral">Cancel</button>
            <button onclick="loadSelectedFile()" class="btn btn-primary">Load</button>
        </div>
    </div>
    
    <div id="new-zone-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-2">New Zone File</h2>
        <label class="form-label">Filename</label>
        <input id="new-zone-name" class="form-input mb-4" placeholder="zones/my_new_area.json">
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="btn btn-neutral">Cancel</button>
            <button onclick="confirmNewZone()" class="btn btn-primary">Create</button>
        </div>
    </div>

    <div id="move-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-2">Move Room to Zone</h2>
        <p class="text-xs text-gray-400 mb-4">Move the selected room(s) to another file.</p>
        <label class="form-label">Target Zone</label>
        <select id="move-target-zone" class="form-select mb-4"></select>
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="btn btn-neutral">Cancel</button>
            <button onclick="confirmMoveRoom()" class="btn btn-primary">Move</button>
        </div>
    </div>
    
    <div id="interior-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-amber-500 mb-2">Create Interior</h2>
        <p class="text-xs text-gray-400 mb-4">Creates a new file and links it to the selected room.</p>
        <label class="form-label">New Filename</label>
        <input id="int-filename" class="form-input mb-2" placeholder="zones/shops/inn.json">
        <label class="form-label">Interior ID</label>
        <input id="int-id" class="form-input mb-2" placeholder="inn">
        <label class="form-label">Entry Room Name</label>
        <input id="int-room-name" class="form-input mb-4" placeholder="Inn Lobby">
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="btn btn-neutral">Cancel</button>
            <button onclick="confirmAddInterior()" class="btn btn-success">Create</button>
        </div>
    </div>
</div>

<datalist id="dl-monsters"></datalist>
<datalist id="dl-items"></datalist>
<datalist id="dl-nodes"></datalist>

<script>
    // --- STATE ---
    let projectData = {}; 
    let activeRoom = null; 
    let gameAssets = { monsters: [], items: [], nodes: [] };
    
    // Viewport
    let scale = 1.0;
    let pan = { x: 0, y: 0 };
    let isDraggingMap = false;
    let isDraggingZone = false;
    let dragStart = { x: 0, y: 0 };
    let activeZoneDrag = null; 
    let isoMode = false;
    
    // NEW: Multi-Z State
    let activeZLevels = new Set([0]);
    let contextTarget = null; 
    
    // Connection State
    let connectSource = null;

    const ROOM_SIZE = 24;
    const CELL_SIZE = 40;

    // --- CONFIGURATION ---
    const ROOM_FLAGS = [
        { key: "is_node", label: "Node (Regen)" },
        { key: "is_super_node", label: "Super Node" },
        { key: "is_sanctuary", label: "Sanctuary" },
        { key: "is_pvp", label: "PvP Allowed" },
        { key: "magic_allowed", label: "Magic Allowed", default: true },
        { key: "stealing_allowed", label: "Stealing Allowed", default: true },
        { key: "teleport_in_allowed", label: "Teleport In", default: true },
        { key: "teleport_out_allowed", label: "Teleport Out", default: true },
        { key: "hiding_allowed", label: "Hiding Allowed", default: true },
        { key: "sneak_in_allowed", label: "Sneak In Allowed", default: true },
        { key: "sneak_out_allowed", label: "Sneak Out Allowed", default: true }
    ];

    const REVERSE_DIRS = {
        'north': 'south', 'south': 'north',
        'east': 'west', 'west': 'east',
        'northeast': 'southwest', 'southwest': 'northeast',
        'northwest': 'southeast', 'southeast': 'northwest',
        'up': 'down', 'down': 'up'
    };
    
    window.onload = async () => {
        const container = document.getElementById('map-container');
        pan.x = container.clientWidth / 2;
        pan.y = container.clientHeight / 2;
        updateTransform();
        
        generateFlagGrid();
        await fetchAssets();
        
        if (Object.keys(projectData).length === 0) {
            createZone("unsaved_zone.json"); 
        }
        renderMap();
        rebuildZToggles(); // Init toggles
    };

    function generateFlagGrid() {
        const grid = document.getElementById('flags-container');
        grid.innerHTML = ROOM_FLAGS.map(f => `
            <label class="flag-item">
                <input type="checkbox" class="room-flag" data-key="${f.key}" onchange="updateRoomData()">
                ${f.label}
            </label>
        `).join('');
    }

    // --- ASSETS ---
    async function fetchAssets() {
        try {
            const res = await fetch('/api/assets');
            gameAssets = await res.json();
            const populate = (id, list) => {
                document.getElementById(id).innerHTML = list.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            };
            populate('dl-monsters', gameAssets.monsters);
            populate('dl-items', gameAssets.items);
            populate('dl-nodes', gameAssets.nodes);
        } catch(e) { console.error("Asset load failed", e); }
    }

    // --- CORE LOGIC ---
    window.createZone = function(filename) {
        if (!filename.endsWith('.json')) filename += '.json';
        if (projectData[filename]) return;
        projectData[filename] = {
            rooms: [],
            offset: { x: Object.keys(projectData).length * 250, y: 50 }
        };
        updateFileList();
        rebuildZToggles();
        return filename;
    }

    function createRoom(filename, x, y, z, name="New Room") {
        const zone = projectData[filename];
        const newId = `room_${Date.now()}_${Math.floor(Math.random()*1000)}`;
        const newRoom = {
            room_id: newId, name: name, x, y, z,
            interior_id: filename.includes('/') ? filename.split('/').pop().replace('.json','') : "",
            description: { default: "" },
            exits: {},
            objects: [],
            hidden_objects: [],
            flags: {},
            ambient_events: [],
            illumination: 50,
            is_table: false
        };
        // Set defaults
        ROOM_FLAGS.forEach(f => { if(f.default) newRoom.flags[f.key] = true; });
        
        zone.rooms.push(newRoom);
        
        // Auto-enable the new room's Z level if not visible
        if (!activeZLevels.has(z)) {
            activeZLevels.add(z);
            rebuildZToggles();
        }

        setActiveRoom(filename, zone.rooms.length - 1);
        renderMap();
    }

    function setActiveRoom(filename, index) {
        activeRoom = { file: filename, index: index };
        const room = projectData[filename].rooms[index];
        
        document.getElementById('no-selection').classList.add('hidden');
        document.getElementById('room-editor').classList.remove('hidden');
        
        // Basic Fields
        document.getElementById('room_id').value = room.room_id;
        document.getElementById('name').value = room.name;
        document.getElementById('x').value = room.x;
        document.getElementById('y').value = room.y;
        document.getElementById('z').value = room.z;
        document.getElementById('desc').value = room.description.default || "";
        document.getElementById('file-badge').innerText = filename;
        document.getElementById('is_outdoor').checked = !!room.is_outdoor;
        document.getElementById('is_table').checked = !!room.is_table;
        
        // Illumination
        const light = room.illumination !== undefined ? room.illumination : 50;
        document.getElementById('illumination').value = light;
        document.getElementById('illumination-val').innerText = light;

        // Flags
        const rFlags = room.flags || {};
        document.querySelectorAll('.room-flag').forEach(cb => {
            const key = cb.getAttribute('data-key');
            let val = rFlags[key];
            if (val === undefined) {
                const def = ROOM_FLAGS.find(f => f.key === key).default;
                val = !!def;
            }
            cb.checked = val;
        });

        // Ambient
        const ambList = document.getElementById('ambient-list');
        ambList.innerHTML = '';
        (room.ambient_events || []).forEach(evt => addAmbientRow(evt));

        renderLists(room);
        renderMap();
        updateJsonPreview(); 
    }

    function getActiveRoomObj() {
        if (!activeRoom) return null;
        return projectData[activeRoom.file].rooms[activeRoom.index];
    }

    function updateIlluminationDisplay() {
        document.getElementById('illumination-val').innerText = document.getElementById('illumination').value;
    }

    // --- LIST RENDERING ---
    function renderLists(room) {
        const exList = document.getElementById('exits-list');
        exList.innerHTML = '';
        Object.entries(room.exits || {}).forEach(([dir, target]) => {
            exList.appendChild(createExitRow(dir, target));
        });

        const obList = document.getElementById('objects-list');
        obList.innerHTML = '';
        (room.objects || []).forEach(obj => obList.appendChild(createObjectCard(obj, false)));
        (room.hidden_objects || []).forEach(obj => obList.appendChild(createObjectCard(obj, true)));
    }

    function createExitRow(dir='', target='') {
        const div = document.createElement('div');
        div.className = 'exit-row flex gap-1 items-center';
        div.innerHTML = `
            <input class="form-input exit-dir w-16 text-xs" value="${dir}" placeholder="Dir" onchange="updateRoomData()">
            <input class="form-input exit-target flex-1 text-xs text-blue-400" value="${target}" placeholder="Room ID" onchange="updateRoomData()">
            <button onclick="this.parentElement.remove();updateRoomData()" class="text-red-500 font-bold px-2">×</button>
        `;
        return div;
    }

    window.addAmbientRow = function(evt=null) {
        const list = document.getElementById('ambient-list');
        const div = document.createElement('div');
        div.className = "flex gap-1 ambient-row items-center mb-1 bg-black/30 p-1 rounded";
        const type = evt ? evt.type : 'periodic';
        const val = evt ? (type==='periodic' ? (evt.chance||0.1) : (evt.time||'DAWN')) : 0.1;
        const msg = evt ? evt.message : '';

        div.innerHTML = `
            <select class="form-select text-[10px] w-20 amb-type" onchange="toggleAmbientInput(this); updateRoomData()">
                <option value="periodic" ${type==='periodic'?'selected':''}>Chance</option>
                <option value="time" ${type==='time'?'selected':''}>Time</option>
            </select>
            <div class="amb-trigger-container w-24"></div>
            <input class="form-input flex-1 text-xs amb-message" value="${msg.replace(/"/g, '&quot;')}" placeholder="Message..." onchange="updateRoomData()">
            <button onclick="this.closest('.ambient-row').remove();updateRoomData()" class="text-red-500 font-bold px-1">×</button>
        `;
        list.appendChild(div);
        renderAmbientTriggerInput(div.querySelector('.amb-trigger-container'), type, val);
    }

    window.toggleAmbientInput = function(select) {
        const row = select.closest('.ambient-row');
        const container = row.querySelector('.amb-trigger-container');
        const type = select.value;
        const val = type === 'periodic' ? 0.1 : 'DAWN';
        renderAmbientTriggerInput(container, type, val);
    }

    function renderAmbientTriggerInput(container, type, value) {
        if(type === 'periodic') {
            container.innerHTML = `<input type="number" step="0.01" min="0" max="1" class="form-input text-xs amb-val" value="${value}" placeholder="0.1" onchange="updateRoomData()">`;
        } else {
            const times = ["DAWN", "MORNING", "NOON", "AFTERNOON", "DUSK", "EVENING", "NIGHT", "MIDNIGHT"];
            const options = times.map(t => `<option value="${t}" ${t===value?'selected':''}>${t}</option>`).join('');
            container.innerHTML = `<select class="form-select text-xs amb-val" onchange="updateRoomData()">${options}</select>`;
        }
    }

    function createObjectCard(obj={}, isHidden=false) {
        const div = document.createElement('div');
        div.className = 'object-card object-row';
        if (isHidden) div.classList.add('hidden-obj');
        
        let type = 'static';
        let val = obj.name || "";
        if (obj.monster_id) { type = 'monster'; val = obj.monster_id; }
        else if (obj.item_id) { type = 'item'; val = obj.item_id; }
        else if (obj.node_id) { type = 'node'; val = obj.node_id; }

        div.innerHTML = `
            <div class="flex justify-between mb-2 border-b border-gray-700 pb-1">
                <select class="obj-type bg-transparent text-xs font-bold text-amber-500 border-none p-0 cursor-pointer" onchange="changeObjType(this)">
                    <option value="static" ${type==='static'?'selected':''}>Static</option>
                    <option value="monster" ${type==='monster'?'selected':''}>Monster</option>
                    <option value="item" ${type==='item'?'selected':''}>Item</option>
                    <option value="node" ${type==='node'?'selected':''}>Node</option>
                </select>
                <div class="flex items-center gap-2">
                    <label class="text-[10px] text-gray-400 flex items-center gap-1">
                        <input type="checkbox" class="obj-hidden accent-amber-500" ${isHidden ? 'checked' : ''} onchange="updateRoomData()"> Hidden
                    </label>
                    <button onclick="this.closest('.object-row').remove();updateRoomData()" class="text-red-500 font-bold text-xs">×</button>
                </div>
            </div>
            <div class="obj-body">${renderObjectBody(type, val, obj)}</div>
        `;
        return div;
    }

    function renderObjectBody(type, val, obj) {
        if (type === 'static') {
            let interactionsToRender = { ... (obj.interactions || {}) };
            if (obj.target_room) interactionsToRender['ENTER'] = { type: 'move', value: obj.target_room };

            const interactionsHtml = Object.entries(interactionsToRender).map(([verb, data]) => `
                <div class="interaction-row">
                    <input class="form-input text-[10px] h-5 p-0 w-12 bg-black ia-verb" value="${verb}" onchange="updateRoomData()">
                    <select class="form-select text-[10px] h-5 p-0 w-16 bg-black ia-type" onchange="updateRoomData()">
                        <option value="text" ${data.type==='text'?'selected':''}>Msg</option>
                        <option value="move" ${data.type==='move'?'selected':''}>Move</option>
                        <option value="script" ${data.type==='script'?'selected':''}>Code</option>
                    </select>
                    <input class="form-input text-[10px] h-5 p-0 px-1 flex-1 bg-black ia-value" value="${data.value||''}" onchange="updateRoomData()">
                    <button onclick="this.parentElement.remove();updateRoomData()" class="text-red-500 font-bold px-1 text-[10px]">×</button>
                </div>
            `).join('');

            return `
                <input class="form-input text-xs mb-1 obj-id-name" value="${val}" placeholder="Name (e.g. rusty lever)" onchange="updateRoomData()">
                <input class="form-input text-xs mb-1 obj-keys" value="${(obj.keywords||[]).join(',')}" placeholder="Keywords" onchange="updateRoomData()">
                <textarea class="form-textarea text-xs h-10 mb-1 obj-desc" placeholder="Description" onchange="updateRoomData()">${obj.description||''}</textarea>
                <div class="mt-1">
                    <div class="flex justify-between items-center"><span class="text-[10px] text-gray-500">INTERACTIONS</span><button onclick="addInteractionRow(this)" class="text-[10px] text-blue-400">+ Add</button></div>
                    <div class="interactions-list space-y-1">${interactionsHtml}</div>
                </div>
            `;
        } else {
            return `
                <label class="form-label">Asset ID</label>
                <input class="form-input text-xs obj-id-name text-green-400" list="dl-${type}s" value="${val}" placeholder="Search ${type}..." onchange="updateRoomData()">
            `;
        }
    }

    // --- GLOBAL HELPERS ---
    window.changeObjType = function(select) {
        const type = select.value;
        const body = select.closest('.object-card').querySelector('.obj-body');
        body.innerHTML = renderObjectBody(type, "", {});
        updateRoomData();
    };

    window.addInteractionRow = function(btn) {
        const container = btn.parentElement.nextElementSibling;
        const div = document.createElement('div');
        div.className = 'interaction-row';
        div.innerHTML = `
            <input class="form-input text-[10px] h-5 p-0 w-12 bg-black ia-verb" placeholder="verb" onchange="updateRoomData()">
            <select class="form-select text-[10px] h-5 p-0 w-16 bg-black ia-type" onchange="updateRoomData()">
                <option value="text">Msg</option> <option value="move">Move</option> <option value="script">Code</option>
            </select>
            <input class="form-input text-[10px] h-5 p-0 px-1 flex-1 bg-black ia-value" placeholder="Value" onchange="updateRoomData()">
            <button onclick="this.parentElement.remove();updateRoomData()" class="text-red-500 font-bold px-1 text-[10px]">×</button>
        `;
        container.appendChild(div);
    };

    window.addExitRow = function() { document.getElementById('exits-list').appendChild(createExitRow()); };
    window.addObjectRow = function() { document.getElementById('objects-list').appendChild(createObjectCard({name:""})); };

    function checkZChange() {
        const z = parseInt(document.getElementById('z').value) || 0;
        if (!activeZLevels.has(z)) {
            activeZLevels.add(z);
            rebuildZToggles();
        }
    }

    function updateRoomData() {
        const r = getActiveRoomObj();
        if (!r) return;
        
        r.room_id = document.getElementById('room_id').value;
        r.name = document.getElementById('name').value;
        r.x = parseInt(document.getElementById('x').value) || 0;
        r.y = parseInt(document.getElementById('y').value) || 0;
        r.z = parseInt(document.getElementById('z').value) || 0;
        r.description.default = document.getElementById('desc').value;
        r.is_outdoor = document.getElementById('is_outdoor').checked;
        r.is_table = document.getElementById('is_table').checked;
        r.illumination = parseInt(document.getElementById('illumination').value);
        
        r.flags = {};
        document.querySelectorAll('.room-flag').forEach(cb => r.flags[cb.getAttribute('data-key')] = cb.checked);

        r.ambient_events = [];
        document.querySelectorAll('.ambient-row').forEach(row => {
            const type = row.querySelector('.amb-type').value;
            const msg = row.querySelector('.amb-message').value.trim();
            const valInput = row.querySelector('.amb-val');
            if(msg) {
                let evt = { type: type, message: msg };
                if (type === 'periodic') evt.chance = parseFloat(valInput.value) || 0.1;
                else evt.time = valInput.value;
                r.ambient_events.push(evt);
            }
        });

        r.exits = {};
        document.querySelectorAll('.exit-row').forEach(row => {
            const dir = row.querySelector('.exit-dir').value.trim();
            const targetId = row.querySelector('.exit-target').value.trim();
            if (dir && targetId) {
                r.exits[dir] = targetId;
                const rev = REVERSE_DIRS[dir.toLowerCase()];
                if (rev) {
                    const targetInfo = findRoomGlobal(targetId);
                    if (targetInfo && !targetInfo.room.exits[rev]) {
                        targetInfo.room.exits[rev] = r.room_id;
                        showToast(`Auto-linked: ${targetId} (${rev}) -> ${r.room_id}`);
                    }
                }
            }
        });

        r.objects = [];
        r.hidden_objects = [];
        document.querySelectorAll('.object-row').forEach(row => {
            const type = row.querySelector('.obj-type').value;
            const val = row.querySelector('.obj-id-name').value.trim();
            const isHidden = row.querySelector('.obj-hidden').checked;
            
            if (isHidden) row.classList.add('hidden-obj'); else row.classList.remove('hidden-obj');
            if (!val) return;

            let newObj = {};
            if (type === 'static') {
                newObj.name = val;
                newObj.description = row.querySelector('.obj-desc').value;
                const keys = row.querySelector('.obj-keys').value;
                newObj.keywords = keys ? keys.split(',') : val.toLowerCase().split(' ');
                newObj.verbs = ["look"];
                
                const interactions = {};
                row.querySelectorAll('.interaction-row').forEach(ir => {
                    const v = ir.querySelector('.ia-verb').value.trim();
                    const t = ir.querySelector('.ia-type').value;
                    const d = ir.querySelector('.ia-value').value;
                    if (v) {
                        if (v.toLowerCase() === 'enter' && t === 'move') {
                            newObj.target_room = d;
                            newObj.verbs.push(v); 
                        } else {
                            interactions[v] = { type: t, value: d };
                            newObj.verbs.push(v);
                        }
                    }
                });
                if (Object.keys(interactions).length > 0) newObj.interactions = interactions;
            } else {
                if (type === 'monster') { newObj.monster_id = val; newObj.is_monster = true; }
                else if (type === 'item') { newObj.item_id = val; newObj.is_item = true; }
                else if (type === 'node') { newObj.node_id = val; newObj.is_gathering_node = true; }
            }
            
            if (isHidden) {
                if (!newObj.perception_dc) newObj.perception_dc = 1;
                r.hidden_objects.push(newObj);
            } else {
                r.objects.push(newObj);
            }
        });

        renderMap();
        updateJsonPreview();
    }

    function updateJsonPreview() {
        const r = getActiveRoomObj();
        document.getElementById('json-preview').value = r ? JSON.stringify(r, null, 4) : '';
    }

    // --- MULTI-Z LOGIC ---
    function rebuildZToggles() {
        const container = document.getElementById('z-toggles-container');
        container.innerHTML = '';
        
        // Find ALL unique Z levels from loaded zones
        const zSet = new Set();
        Object.values(projectData).forEach(zone => {
            zone.rooms.forEach(r => {
                if(r.z !== undefined) zSet.add(r.z);
            });
        });
        
        // Always include 0
        zSet.add(0);
        
        const sortedZ = Array.from(zSet).sort((a,b) => a - b);
        
        if (sortedZ.length === 0) {
            container.innerHTML = '<span class="text-[9px] text-gray-500 italic">No rooms loaded</span>';
            return;
        }

        sortedZ.forEach(z => {
            const btn = document.createElement('div');
            btn.className = `z-toggle-btn ${activeZLevels.has(z) ? 'active' : ''}`;
            if (z < 0) btn.classList.add('z-under');
            if (z > 0) btn.classList.add('z-over');
            
            btn.textContent = z;
            btn.onclick = () => {
                if (activeZLevels.has(z)) {
                    activeZLevels.delete(z);
                    btn.classList.remove('active');
                } else {
                    activeZLevels.add(z);
                    btn.classList.add('active');
                }
                renderMap();
            };
            container.appendChild(btn);
        });
    }

    // --- MAP RENDERING (UPDATED) ---
    function renderMap() {
        const svg = document.getElementById('map-content');
        svg.innerHTML = '';
        const showTables = document.getElementById('show-tables-toggle').checked;

        // --- LAYER 1: ZONE BACKGROUNDS (HANDLES) ---
        // This restores the ability to move zones!
        Object.entries(projectData).forEach(([filename, zone]) => {
            let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
            let hasVisibleRooms = false;

            // Calculate bounds based on VISIBLE rooms
            zone.rooms.forEach(r => {
                // Check visibility
                if (!isoMode && !activeZLevels.has(r.z)) return;
                if (!showTables && r.is_table) return;

                hasVisibleRooms = true;
                const c = getScreenCoords(r.x, r.y, r.z, zone.offset);
                minX = Math.min(minX, c.x); maxX = Math.max(maxX, c.x);
                minY = Math.min(minY, c.y); maxY = Math.max(maxY, c.y);
            });

            if (hasVisibleRooms) {
                const pad = 30;
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.classList.add('zone-group');

                const bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                bg.setAttribute("x", minX - pad); bg.setAttribute("y", minY - pad);
                bg.setAttribute("width", maxX - minX + pad*2 + ROOM_SIZE);
                bg.setAttribute("height", maxY - minY + pad*2 + ROOM_SIZE);
                bg.classList.add("zone-bg");
                bg.onmousedown = (e) => startZoneDrag(e, filename); // <--- Drag Handler Attached Here
                
                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute("x", minX - pad); label.setAttribute("y", minY - pad - 5);
                label.textContent = filename;
                label.classList.add("zone-label");
                
                g.appendChild(bg); g.appendChild(label);
                svg.appendChild(g);
            }
        });

        // --- LAYER 2: LINKS & ROOMS (Z-SORTED) ---
        const sortedActiveZ = Array.from(activeZLevels).sort((a,b) => a - b);

        sortedActiveZ.forEach(drawingZ => {
            // Draw Links
            Object.values(projectData).forEach(zone => {
                zone.rooms.forEach(r => {
                    if (!isoMode && r.z !== drawingZ) return; 
                    if (!showTables && r.is_table) return;

                    const start = getScreenCoords(r.x, r.y, r.z, zone.offset);
                    Object.entries(r.exits).forEach(([dir, targetId]) => {
                        const targetInfo = findRoomGlobal(targetId);
                        if (targetInfo) {
                            const tZ = targetInfo.room.z;
                            if (!isoMode && !activeZLevels.has(tZ)) return; 
                            if (!showTables && targetInfo.room.is_table) return;

                            const end = getScreenCoords(targetInfo.room.x, targetInfo.room.y, tZ, targetInfo.zone.offset);
                            drawLink(svg, start, end, targetInfo.file !== activeRoom?.file, r.z, tZ);
                        }
                    });
                });
            });

            // Draw Rooms
            Object.entries(projectData).forEach(([filename, zone]) => {
                zone.rooms.forEach((r, i) => {
                    if (!isoMode && r.z !== drawingZ) return;
                    if (!showTables && r.is_table) return;

                    const c = getScreenCoords(r.x, r.y, r.z, zone.offset);
                    const rg = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    rg.classList.add("map-room");
                    if (activeRoom?.file === filename && activeRoom?.index === i) rg.classList.add("current");
                    
                    rg.onclick = (e) => handleRoomClick(e, r, filename, i);
                    rg.oncontextmenu = (e) => { e.preventDefault(); openContextMenu(e, r, filename); };

                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", c.x); rect.setAttribute("y", c.y);
                    rect.setAttribute("width", ROOM_SIZE); rect.setAttribute("height", ROOM_SIZE);
                    
                    if (isoMode) {
                        const depth = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        depth.setAttribute("d", `M ${c.x} ${c.y+ROOM_SIZE} L ${c.x} ${c.y+ROOM_SIZE+5} L ${c.x+ROOM_SIZE} ${c.y+ROOM_SIZE+5} L ${c.x+ROOM_SIZE} ${c.y+ROOM_SIZE} Z`);
                        depth.setAttribute("fill", "#222");
                        rg.appendChild(depth);
                    }

                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", c.x + ROOM_SIZE/2); text.setAttribute("y", c.y + ROOM_SIZE/2 + 3);
                    text.textContent = r.room_id.substring(0, 3);

                    rg.appendChild(rect); rg.appendChild(text);
                    svg.appendChild(rg);
                });
            });
        });
    }

    function handleRoomClick(e, targetRoom, filename, index) {
        e.stopPropagation();
        
        if (connectSource) {
            const src = connectSource.room;
            const tgt = targetRoom;
            if (src.room_id === tgt.room_id) return;
            
            const dx = tgt.x - src.x, dy = tgt.y - src.y, dz = tgt.z - src.z;
            let dir = null;
            if (dz === 0) {
                if (dy === 1 && dx === 0) dir = 'north';
                else if (dy === -1 && dx === 0) dir = 'south';
                else if (dx === 1 && dy === 0) dir = 'east';
                else if (dx === -1 && dy === 0) dir = 'west';
                else if (dx === 1 && dy === 1) dir = 'northeast';
                else if (dx === 1 && dy === -1) dir = 'southeast';
                else if (dx === -1 && dy === 1) dir = 'northwest';
                else if (dx === -1 && dy === -1) dir = 'southwest';
            } else if (dx===0 && dy===0) {
                if (dz > 0) dir = 'up'; // Difference is positive
                else if (dz < 0) dir = 'down';
            }
            
            if (dir) {
                src.exits[dir] = tgt.room_id;
                if (REVERSE_DIRS[dir]) tgt.exits[REVERSE_DIRS[dir]] = src.room_id;
                showToast(`Connected ${src.room_id} -> ${tgt.room_id}`);
                connectSource = null; document.body.style.cursor = "default";
                if (activeRoom) setActiveRoom(activeRoom.file, activeRoom.index);
                renderMap();
            } else {
                const manualDir = prompt("Could not determine cardinal direction. Enter direction:");
                if (manualDir) {
                    src.exits[manualDir] = tgt.room_id;
                    if (REVERSE_DIRS[manualDir]) tgt.exits[REVERSE_DIRS[manualDir]] = src.room_id;
                    connectSource = null; document.body.style.cursor = "default";
                    if (activeRoom) setActiveRoom(activeRoom.file, activeRoom.index);
                    renderMap();
                }
            }
            return;
        }

        // Logic for handling overlapping rooms (Cycle selection)
        // Only consider rooms in activeZLevels
        const targetZone = projectData[filename];
        const targetCoords = getScreenCoords(targetRoom.x, targetRoom.y, targetRoom.z, targetZone.offset);
        const showTables = document.getElementById('show-tables-toggle').checked;

        const overlaps = [];
        // Important: Reverse sort so we hit-test top-most visible layers first?
        // Actually, render order puts top last. 
        for (const [fName, zone] of Object.entries(projectData)) {
            zone.rooms.forEach((r, idx) => {
                if (!isoMode && !activeZLevels.has(r.z)) return;
                if (!showTables && r.is_table) return;

                const c = getScreenCoords(r.x, r.y, r.z, zone.offset);
                if (Math.abs(c.x - targetCoords.x) < 1 && Math.abs(c.y - targetCoords.y) < 1) {
                    overlaps.push({ file: fName, index: idx, room: r });
                }
            });
        }
        
        // Sort overlaps by Z descending (Top to Bottom selection preference)
        overlaps.sort((a,b) => b.room.z - a.room.z);

        if (overlaps.length <= 1) {
            setActiveRoom(filename, index);
            return;
        }

        let nextIdx = 0;
        if (activeRoom) {
            const currentInOverlap = overlaps.findIndex(o => o.file === activeRoom.file && o.index === activeRoom.index);
            if (currentInOverlap !== -1) {
                nextIdx = (currentInOverlap + 1) % overlaps.length;
            }
        }
        
        const next = overlaps[nextIdx];
        setActiveRoom(next.file, next.index);
        showToast(`Selected: ${next.room.name || next.room.room_id} (Z: ${next.room.z})`);
    }

    function showToast(msg) {
        let toast = document.getElementById('toast-notification');
        toast.innerText = msg;
        toast.style.opacity = 1;
        if (toast.timeoutId) clearTimeout(toast.timeoutId);
        toast.timeoutId = setTimeout(() => { toast.style.opacity = 0; }, 2000);
    }

    function getScreenCoords(x, y, z, offset) {
        let sx, sy;
        if (isoMode) {
            sx = (x - y) * (CELL_SIZE * 0.8);
            sy = (x + y) * (CELL_SIZE * 0.4) - (z * CELL_SIZE * 1.5);
        } else {
            sx = x * CELL_SIZE;
            sy = -y * CELL_SIZE;
        }
        return { x: sx + offset.x, y: sy + offset.y };
    }

    function drawLink(parent, p1, p2, isCross, z1, z2) {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", p1.x + ROOM_SIZE/2); line.setAttribute("y1", p1.y + ROOM_SIZE/2);
        line.setAttribute("x2", p2.x + ROOM_SIZE/2); line.setAttribute("y2", p2.y + ROOM_SIZE/2);
        line.classList.add("map-link");
        if (isCross) line.classList.add("cross-zone");
        
        // Fade lines that go between layers if not in iso mode?
        if (!isoMode && z1 !== z2) {
            line.style.opacity = 0.3;
            line.style.strokeDasharray = "2,2";
        }

        parent.insertBefore(line, parent.firstChild);
    }

    function findRoomGlobal(id) {
        for (const [file, data] of Object.entries(projectData)) {
            const r = data.rooms.find(r => r.room_id === id);
            if (r) return { room: r, file: file, zone: data };
        }
        return null;
    }

    // --- INTERACTION ---
    function startPan(e) {
        if (e.target.tagName !== 'svg') return;
        isDraggingMap = true;
        dragStart = { x: e.clientX, y: e.clientY };
        document.body.style.cursor = "grabbing";
        
        const move = (ev) => {
            pan.x += ev.clientX - dragStart.x;
            pan.y += ev.clientY - dragStart.y;
            dragStart = { x: ev.clientX, y: ev.clientY };
            updateTransform();
        };
        const up = () => {
            isDraggingMap = false;
            document.body.style.cursor = "default";
            window.removeEventListener('mousemove', move);
            window.removeEventListener('mouseup', up);
        };
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
    }

    function startZoneDrag(e, filename) {
        e.stopPropagation();
        dragStart = { x: e.clientX, y: e.clientY };
        
        const move = (ev) => {
            projectData[filename].offset.x += (ev.clientX - dragStart.x) / scale;
            projectData[filename].offset.y += (ev.clientY - dragStart.y) / scale;
            dragStart = { x: ev.clientX, y: ev.clientY };
            renderMap();
        };
        const up = () => {
            window.removeEventListener('mousemove', move);
            window.removeEventListener('mouseup', up);
        };
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
    }

    function handleZoom(e) {
        e.preventDefault();
        scale *= e.deltaY > 0 ? 0.9 : 1.1;
        updateTransform();
    }
    
    function updateTransform() {
        document.getElementById('map-content').setAttribute('transform', `translate(${pan.x}, ${pan.y}) scale(${scale})`);
    }

    // --- UTILS ---
    function quickBuild(dir, dx, dy, dz=0) {
        if (!activeRoom) return;
        const r = getActiveRoomObj();
        const zone = projectData[activeRoom.file];
        
        const tx = r.x+dx, ty = r.y+dy, tz = r.z+dz;
        let target = zone.rooms.find(xr => xr.x===tx && xr.y===ty && xr.z===tz);
        
        if (!target) {
            createRoom(activeRoom.file, tx, ty, tz);
            target = zone.rooms[zone.rooms.length-1];
        }
        
        r.exits[dir] = target.room_id;
        if (REVERSE_DIRS[dir]) target.exits[REVERSE_DIRS[dir]] = r.room_id;
        setActiveRoom(activeRoom.file, activeRoom.index);
    }

    function setIsoMode(val) {
        isoMode = val;
        document.getElementById('btn-2d').classList.toggle('btn-primary', !val);
        document.getElementById('btn-2d').classList.toggle('btn-neutral', val);
        document.getElementById('btn-3d').classList.toggle('btn-primary', val);
        document.getElementById('btn-3d').classList.toggle('btn-neutral', !val);
        renderMap();
    }

    function openContextMenu(e, room, filename) {
        contextTarget = { room, filename };
        const m = document.getElementById('context-menu');
        m.style.display = 'block';
        m.style.left = e.clientX + 'px'; m.style.top = e.clientY + 'px';
        const hide = () => { m.style.display = 'none'; window.removeEventListener('click', hide); };
        window.addEventListener('click', hide);
    }

    // --- MODAL ACTIONS ---
    function actionConnect() {
        if (!contextTarget) return;
        connectSource = contextTarget;
        document.body.style.cursor = "crosshair";
        showToast("Select target room to connect...");
    }

    function actionAddInterior() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.add('hidden');
        document.getElementById('move-modal').classList.add('hidden');
        document.getElementById('new-zone-modal').classList.add('hidden');
        document.getElementById('interior-modal').classList.remove('hidden');
        const rid = contextTarget.room.room_id;
        document.getElementById('int-filename').value = `zones/interiors/${rid}_int.json`;
        document.getElementById('int-id').value = `${rid}_inside`;
    }

    function confirmAddInterior() {
        const fname = document.getElementById('int-filename').value;
        const intId = document.getElementById('int-id').value;
        const rName = document.getElementById('int-room-name').value;
        if (!fname) return;

        createZone(fname);
        const newZone = projectData[fname];
        const newRoom = newZone.rooms[0];
        newRoom.name = rName;
        newRoom.interior_id = intId;
        newRoom.room_id = `${intId}_entry`;
        
        const source = contextTarget.room;
        source.exits[`enter ${intId}`] = newRoom.room_id;
        newRoom.exits["out"] = source.room_id;
        
        // Offset visual
        const srcZone = projectData[contextTarget.filename];
        newZone.offset.x = srcZone.offset.x + 200;
        newZone.offset.y = srcZone.offset.y + 50;
        
        closeModal();
        rebuildZToggles();
        renderMap();
        updateRoomData();
    }

    function openNewZoneModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.add('hidden');
        document.getElementById('interior-modal').classList.add('hidden');
        document.getElementById('move-modal').classList.add('hidden');
        document.getElementById('new-zone-modal').classList.remove('hidden');
    }
    function confirmNewZone() {
        const name = document.getElementById('new-zone-name').value;
        if(name) createZone(name);
        closeModal();
    }

    function openMoveModal() {
        if (!contextTarget && !activeRoom) return;
        if (!contextTarget) contextTarget = { room: getActiveRoomObj(), filename: activeRoom.file };

        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.add('hidden');
        document.getElementById('interior-modal').classList.add('hidden');
        document.getElementById('new-zone-modal').classList.add('hidden');
        document.getElementById('move-modal').classList.remove('hidden');

        const sel = document.getElementById('move-target-zone');
        sel.innerHTML = Object.keys(projectData)
            .filter(f => f !== contextTarget.filename)
            .map(f => `<option value="${f}">${f}</option>`)
            .join('');
        sel.innerHTML += `<option value="__NEW__">+ Create New Zone</option>`;
    }

    function confirmMoveRoom() {
        let targetFile = document.getElementById('move-target-zone').value;
        if (targetFile === "__NEW__") {
            targetFile = prompt("New filename:");
            if (!targetFile) return;
            createZone(targetFile);
        }
        
        const sourceFile = contextTarget.filename;
        const roomToMove = contextTarget.room;
        
        const idx = projectData[sourceFile].rooms.indexOf(roomToMove);
        if (idx > -1) {
            projectData[sourceFile].rooms.splice(idx, 1);
            projectData[targetFile].rooms.push(roomToMove);
        }

        closeModal();
        updateFileList();
        activeRoom = null;
        document.getElementById('room-editor').classList.add('hidden');
        renderMap();
        rebuildZToggles();
    }

    function openLoadModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.remove('hidden');
        document.getElementById('interior-modal').classList.add('hidden');
        document.getElementById('new-zone-modal').classList.add('hidden');
        document.getElementById('move-modal').classList.add('hidden');

        fetch('/api/zones').then(r=>r.json()).then(files => {
            document.getElementById('server-file-list').innerHTML = files.map(f => `<option value="${f}">${f}</option>`).join('');
        });
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; contextTarget=null; }

    async function loadSelectedFile() {
        const select = document.getElementById('server-file-list');
        const selectedOptions = Array.from(select.selectedOptions);
        
        if (selectedOptions.length === 0) return;

        const promises = selectedOptions.map(async (option) => {
            const filename = option.value;
            if (projectData[filename]) return null;
            try {
                const res = await fetch(`/api/load?file=${encodeURIComponent(filename)}`);
                const data = await res.json();
                return res.ok ? { filename, data } : null;
            } catch(e) { return null; }
        });

        const results = await Promise.all(promises);
        let loadedCount = 0;

        results.forEach(res => {
            if(res) {
                projectData[res.filename] = {
                    rooms: res.data,
                    offset: { x: Object.keys(projectData).length * 250, y: 50 }
                };
                loadedCount++;
            }
        });

        if (loadedCount > 0) {
            updateFileList();
            rebuildZToggles();
            renderMap();
            closeModal();
        } else {
            alert("No valid files loaded.");
        }
    }

    async function saveAllZones() {
        const payload = {};
        Object.entries(projectData).forEach(([f, d]) => payload[f] = d.rooms);
        const res = await fetch('/api/save_batch', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({files:payload}) });
        const ret = await res.json();
        alert(ret.results.join('\n'));
    }

    async function saveZone(filename) {
        if (!projectData[filename]) return;
        const payload = {};
        payload[filename] = projectData[filename].rooms;
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "⏳";
        
        try {
            await fetch('/api/save_batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: payload })
            });
            btn.innerText = "✓";
            setTimeout(() => btn.innerText = originalText, 1000);
        } catch(e) {
            alert("Error saving " + filename);
            btn.innerText = "⚠️";
        }
    }

    function closeZone(filename) {
        if (!confirm(`Unload ${filename}?`)) return;
        delete projectData[filename];
        if (activeRoom && activeRoom.file === filename) {
            activeRoom = null;
            document.getElementById('room-editor').classList.add('hidden');
            document.getElementById('no-selection').classList.remove('hidden');
        }
        updateFileList();
        rebuildZToggles();
        renderMap();
    }
    
    function focusZone(filename) {
        const z = projectData[filename];
        if (z && z.rooms.length > 0) {
            pan.x = -z.offset.x * scale + (document.getElementById('map-container').clientWidth/2);
            pan.y = -z.offset.y * scale + (document.getElementById('map-container').clientHeight/2);
            updateTransform();
        }
    }

    function updateFileList() {
        const c = document.getElementById('loaded-files-container');
        if (Object.keys(projectData).length === 0) {
            c.innerHTML = '<div class="text-gray-500 text-[10px] italic p-2">No zones loaded</div>';
            return;
        }
        
        c.innerHTML = Object.keys(projectData).map(f => `
            <div class="zone-entry">
                <span class="zone-name" title="${f}" onclick="focusZone('${f}')">${f}</span>
                <div class="zone-actions">
                    <span class="zone-count">${projectData[f].rooms.length}</span>
                    <button class="zone-btn save" onclick="saveZone('${f}')" title="Save File">💾</button>
                    <button class="zone-btn close" onclick="closeZone('${f}')" title="Unload File">✕</button>
                </div>
            </div>
        `).join('');
    }
    
    function deleteRoom() {
        if(!activeRoom || !confirm("Delete this room?")) return;
        const z = projectData[activeRoom.file];
        z.rooms.splice(activeRoom.index, 1);
        activeRoom = null;
        document.getElementById('room-editor').classList.add('hidden');
        rebuildZToggles();
        renderMap();
    }
</script>
</body>
</html>