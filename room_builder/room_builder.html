<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e5e5e5; height: 100vh; overflow: hidden; }
        
        #main-container { display: flex; height: 100vh; }
        #editor-panel { width: 420px; flex-shrink: 0; overflow-y: auto; padding: 1rem; border-right: 1px solid #333; background: #1a1a1a; display: flex; flex-direction: column; gap: 1rem; }
        #visual-panel { flex-grow: 1; display: flex; flex-direction: column; background: #0f0f0f; position: relative; }
        
        /* Map Canvas */
        #map-container { flex-grow: 1; overflow: hidden; cursor: grab; position: relative; 
                         background-image: radial-gradient(#2a2a2a 1px, transparent 1px); background-size: 20px 20px; }
        #map-container:active { cursor: grabbing; }
        #map-content { transform-origin: 0 0; transition: transform 0.1s ease-out; }
        
        /* Room Nodes */
        .map-room rect { fill: #333; stroke: #555; stroke-width: 1; transition: fill 0.1s; cursor: pointer; }
        .map-room:hover rect { fill: #444; stroke: #888; }
        .map-room.current rect { fill: #f59e0b; stroke: #fff; stroke-width: 2; }
        .map-room text { font-size: 8px; fill: #aaa; text-anchor: middle; pointer-events: none; font-family: monospace; user-select: none; }
        
        /* Links */
        .map-link { stroke: #555; stroke-width: 1; pointer-events: none; marker-end: url(#arrowhead); }
        .map-link.cross-zone { stroke: #3b82f6; stroke-width: 2; stroke-dasharray: 4; marker-end: url(#arrowhead-blue); }

        /* Zone Groups */
        .zone-group rect.zone-bg { fill: rgba(50, 50, 50, 0.05); stroke: #444; stroke-width: 1; stroke-dasharray: 4; rx: 8; }
        .zone-group text.zone-label { fill: #555; font-size: 12px; font-weight: bold; opacity: 0.5; pointer-events: none; }
        .zone-group:hover rect.zone-bg { stroke: #666; fill: rgba(60, 60, 60, 0.1); cursor: move; }
        
        /* UI Elements */
        .form-label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 0.2rem; font-weight: 600; text-transform: uppercase; }
        .form-input, .form-textarea, .form-select { width: 100%; background: #222; border: 1px solid #333; color: #fff; padding: 0.4rem; border-radius: 0.25rem; font-size: 0.85rem; font-family: monospace; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #f59e0b; }
        
        .btn { padding: 0.3rem 0.6rem; border-radius: 0.25rem; font-weight: 600; font-size: 0.75rem; cursor: pointer; transition: all 0.1s; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-primary { background: #f59e0b; color: #000; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-neutral { background: #374151; color: #fff; border: 1px solid #4b5563; }
        .btn-success { background: #10b981; color: #fff; }

        /* Object & Interaction Cards */
        .object-card { background: #252525; border: 1px solid #444; border-radius: 4px; padding: 6px; margin-bottom: 6px; }
        .interaction-row { display: flex; gap: 4px; margin-top: 4px; background: #1a1a1a; padding: 4px; border-radius: 3px; border: 1px solid #333; align-items: center; }

        /* Context Menu */
        #context-menu { position: absolute; display: none; background: #222; border: 1px solid #444; border-radius: 4px; z-index: 100; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .ctx-item { padding: 8px 12px; cursor: pointer; font-size: 0.8rem; color: #ccc; }
        .ctx-item:hover { background: #3b82f6; color: white; }
        .ctx-divider { height: 1px; background: #333; margin: 4px 0; }

        /* Zone List Overlay */
        #zone-list { position: absolute; top: 10px; left: 10px; background: rgba(20,20,20,0.9); border: 1px solid #333; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; width: 200px; }
        .zone-entry { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; align-items: center; color: #aaa; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: #1e1e1e; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #444; width: 400px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="main-container">
    <div id="editor-panel">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
            <h1 class="text-amber-500 font-bold">Room Architect</h1>
            <div class="flex gap-2">
                <button onclick="openLoadModal()" class="btn btn-neutral">Load Zone</button>
                <button onclick="saveAllZones()" class="btn btn-success">Save All</button>
            </div>
        </div>

        <form id="room-form" onsubmit="return false;">
            <div id="no-selection" class="text-gray-500 text-center text-sm py-10">Select a room to edit</div>
            
            <div id="room-editor" class="hidden space-y-4">
                <div class="bg-black/20 p-3 rounded border border-white/5">
                    <div class="grid grid-cols-1 gap-2 mb-2">
                        <div>
                            <label class="form-label">Room ID</label>
                            <input type="text" id="room_id" class="form-input text-amber-500 font-bold" oninput="updateRoomData()">
                        </div>
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" id="name" class="form-input" oninput="updateRoomData()">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="form-label">X</label><input type="number" id="x" class="form-input text-center" oninput="updateRoomData()"></div>
                        <div><label class="form-label">Y</label><input type="number" id="y" class="form-input text-center" oninput="updateRoomData()"></div>
                        <div><label class="form-label">Z</label><input type="number" id="z" class="form-input text-center" oninput="updateRoomData()"></div>
                    </div>
                    <div class="mt-2 flex items-center justify-between">
                        <div id="file-badge" class="text-[10px] bg-blue-900/30 text-blue-400 px-2 py-1 rounded truncate max-w-[150px]"></div>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="is_outdoor" class="accent-amber-500" onchange="updateRoomData()">
                            <span class="text-xs text-gray-400">Outdoor</span>
                        </label>
                    </div>
                </div>

                <div class="bg-blue-900/10 border border-blue-900/30 p-2 rounded">
                    <h2 class="text-[10px] font-bold text-blue-400 uppercase mb-1">Quick Build</h2>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <button class="btn btn-neutral h-6" onclick="quickBuild('northwest', -1, 1)">NW</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('north', 0, 1)">N</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('northeast', 1, 1)">NE</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('west', -1, 0)">W</button>
                        <button class="btn btn-neutral h-6 bg-blue-600 text-white" onclick="quickBuild('up', 0, 0, 1)">▲ Up</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('east', 1, 0)">E</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('southwest', -1, -1)">SW</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('south', 0, -1)">S</button>
                        <button class="btn btn-neutral h-6" onclick="quickBuild('southeast', 1, -1)">SE</button>
                        <button class="btn btn-neutral h-6 col-start-2" onclick="quickBuild('down', 0, 0, -1)">▼ Dn</button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Description</label>
                    <textarea id="desc" class="form-textarea h-24" oninput="updateRoomData()"></textarea>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-1"><label class="form-label">Exits</label><button onclick="addExitRow()" class="text-xs text-green-400 hover:text-white">+ Add</button></div>
                    <div id="exits-list" class="space-y-1"></div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1"><label class="form-label">Objects</label><button onclick="addObjectRow()" class="text-xs text-green-400 hover:text-white">+ Add</button></div>
                    <div id="objects-list"></div>
                </div>
                
                <button onclick="deleteRoom()" class="btn btn-danger w-full mt-4">Delete Room</button>
            </div>
        </form>
    </div>

    <div id="visual-panel">
        <div id="zone-list">
            <div class="text-[10px] uppercase font-bold text-gray-500 border-b border-gray-700 mb-1 pb-1">Loaded Zones</div>
            <div id="loaded-files-container"></div>
            <button onclick="createNewZoneFile()" class="text-[10px] text-blue-400 mt-2 hover:text-white w-full text-left">+ New Zone File</button>
        </div>

        <div class="absolute top-2 right-2 flex gap-1 z-10">
            <button class="btn btn-neutral text-xs" id="btn-2d" onclick="setIsoMode(false)">2D</button>
            <button class="btn btn-neutral text-xs" id="btn-3d" onclick="setIsoMode(true)">3D</button>
        </div>
        
        <div class="absolute bottom-2 right-2 z-10 flex items-center bg-black/60 rounded p-1">
             <span class="text-[10px] text-gray-400 mr-2">Level</span>
             <input type="range" id="z-level-slider" min="-5" max="5" step="1" value="0" class="w-24 accent-amber-500" oninput="updateZDisplay()">
             <span id="z-display" class="text-xs font-mono w-8 text-center text-amber-500">0</span>
        </div>

        <div id="map-container" onmousedown="startPan(event)" onwheel="handleZoom(event)" oncontextmenu="return false;">
            <svg id="map-svg" width="100%" height="100%">
                <defs>
                    <marker id="arrowhead" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto">
                        <polygon points="0 0, 5 2.5, 0 5" fill="#555"/>
                    </marker>
                    <marker id="arrowhead-blue" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto">
                        <polygon points="0 0, 5 2.5, 0 5" fill="#3b82f6"/>
                    </marker>
                </defs>
                <g id="map-content"></g>
            </svg>
        </div>
    </div>
</div>

<div id="context-menu">
    <div class="ctx-item" onclick="actionConnect()">Connect to...</div>
    <div class="ctx-item" onclick="actionAddInterior()">Add Building/Interior</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item text-red-400" onclick="deleteRoom()">Delete Room</div>
</div>

<div id="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div id="load-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-4">Load Zone File</h2>
        <select id="server-file-list" class="form-select mb-4 text-sm h-64" size="10"></select>
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="btn btn-neutral">Cancel</button>
            <button onclick="loadSelectedFile()" class="btn btn-primary">Load</button>
        </div>
    </div>
    
    <div id="interior-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-amber-500 mb-2">Create Interior</h2>
        <p class="text-xs text-gray-400 mb-4">Creates a new file and links it to the selected room.</p>
        <label class="form-label">New Filename</label>
        <input id="int-filename" class="form-input mb-2" placeholder="zones/shops/inn.json">
        <label class="form-label">Interior ID</label>
        <input id="int-id" class="form-input mb-2" placeholder="inn">
        <label class="form-label">Entry Room Name</label>
        <input id="int-room-name" class="form-input mb-4" placeholder="Inn Lobby">
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="btn btn-neutral">Cancel</button>
            <button onclick="confirmAddInterior()" class="btn btn-success">Create</button>
        </div>
    </div>
</div>

<datalist id="dl-monsters"></datalist>
<datalist id="dl-items"></datalist>
<datalist id="dl-nodes"></datalist>

<script>
    // --- STATE ---
    let projectData = {}; // { "filename": { rooms: [], offset: {x:0, y:0} } }
    let activeRoom = null; // { file: "filename", index: 0 }
    let gameAssets = { monsters: [], items: [], nodes: [] };
    
    // Viewport
    let scale = 1.0;
    let pan = { x: 0, y: 0 };
    let isDraggingMap = false;
    let isDraggingZone = false;
    let dragStart = { x: 0, y: 0 };
    let activeZoneDrag = null; 
    let isoMode = false;
    let currentZ = 0;
    let contextTarget = null; 

    const ROOM_SIZE = 24;
    const CELL_SIZE = 40;
    
    window.onload = async () => {
        const container = document.getElementById('map-container');
        pan.x = container.clientWidth / 2;
        pan.y = container.clientHeight / 2;
        updateTransform();
        
        await fetchAssets();
        
        if (Object.keys(projectData).length === 0) {
            createZone("unsaved_zone.json");
        }
        renderMap();
    };

    // --- ASSETS ---
    async function fetchAssets() {
        try {
            const res = await fetch('/api/assets');
            gameAssets = await res.json();
            
            const populate = (id, list) => {
                document.getElementById(id).innerHTML = list.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            };
            populate('dl-monsters', gameAssets.monsters);
            populate('dl-items', gameAssets.items);
            populate('dl-nodes', gameAssets.nodes);
        } catch(e) { console.error("Asset load failed", e); }
    }

    // --- CORE LOGIC ---
    function createZone(filename) {
        if (projectData[filename]) return;
        projectData[filename] = {
            rooms: [],
            offset: { x: Object.keys(projectData).length * 200, y: 0 }
        };
        createRoom(filename, 0, 0, 0);
        updateFileList();
    }

    function createRoom(filename, x, y, z, name="New Room") {
        const zone = projectData[filename];
        const newId = `room_${Date.now()}_${Math.floor(Math.random()*1000)}`;
        const newRoom = {
            room_id: newId, name: name, x, y, z,
            interior_id: filename.includes('/') ? filename.split('/').pop().replace('.json','') : "",
            description: { default: "" },
            exits: {},
            objects: []
        };
        zone.rooms.push(newRoom);
        setActiveRoom(filename, zone.rooms.length - 1);
        renderMap();
    }

    function setActiveRoom(filename, index) {
        activeRoom = { file: filename, index: index };
        const room = projectData[filename].rooms[index];
        
        document.getElementById('no-selection').classList.add('hidden');
        document.getElementById('room-editor').classList.remove('hidden');
        
        // Populate fields
        document.getElementById('room_id').value = room.room_id;
        document.getElementById('name').value = room.name;
        document.getElementById('x').value = room.x;
        document.getElementById('y').value = room.y;
        document.getElementById('z').value = room.z;
        document.getElementById('desc').value = room.description.default || "";
        document.getElementById('file-badge').innerText = filename;
        document.getElementById('is_outdoor').checked = !!room.is_outdoor;

        renderLists(room);
        renderMap();
    }

    function getActiveRoomObj() {
        if (!activeRoom) return null;
        return projectData[activeRoom.file].rooms[activeRoom.index];
    }

    // --- LIST RENDERING (OBJECTS & EXITS) ---

    function renderLists(room) {
        // Exits
        const exList = document.getElementById('exits-list');
        exList.innerHTML = '';
        Object.entries(room.exits || {}).forEach(([dir, target]) => {
            exList.appendChild(createExitRow(dir, target));
        });

        // Objects
        const obList = document.getElementById('objects-list');
        obList.innerHTML = '';
        (room.objects || []).forEach(obj => {
            obList.appendChild(createObjectCard(obj));
        });
    }

    function createExitRow(dir='', target='') {
        const div = document.createElement('div');
        div.className = 'exit-row flex gap-1 items-center';
        div.innerHTML = `
            <input class="form-input exit-dir w-16 text-xs" value="${dir}" placeholder="Dir" onchange="updateRoomData()">
            <input class="form-input exit-target flex-1 text-xs text-blue-400" value="${target}" placeholder="Room ID" onchange="updateRoomData()">
            <button onclick="this.parentElement.remove();updateRoomData()" class="text-red-500 font-bold px-2">×</button>
        `;
        return div;
    }

    function createObjectCard(obj={}) {
        const div = document.createElement('div');
        div.className = 'object-card object-row';
        
        // Detect Type
        let type = 'static';
        let val = obj.name || "";
        if (obj.monster_id) { type = 'monster'; val = obj.monster_id; }
        else if (obj.item_id) { type = 'item'; val = obj.item_id; }
        else if (obj.node_id) { type = 'node'; val = obj.node_id; }

        const isRef = type !== 'static';

        div.innerHTML = `
            <div class="flex justify-between mb-2 border-b border-gray-700 pb-1">
                <select class="obj-type bg-transparent text-xs font-bold text-amber-500 border-none p-0 cursor-pointer" onchange="changeObjType(this)">
                    <option value="static" ${type==='static'?'selected':''}>Static</option>
                    <option value="monster" ${type==='monster'?'selected':''}>Monster</option>
                    <option value="item" ${type==='item'?'selected':''}>Item</option>
                    <option value="node" ${type==='node'?'selected':''}>Node</option>
                </select>
                <button onclick="this.closest('.object-row').remove();updateRoomData()" class="text-red-500 font-bold text-xs">×</button>
            </div>
            
            <div class="obj-body">
                ${renderObjectBody(type, val, obj)}
            </div>
        `;
        return div;
    }

    function renderObjectBody(type, val, obj) {
        if (type === 'static') {
            // Interactions HTML generator
            const interactionsHtml = Object.entries(obj.interactions || {}).map(([verb, data]) => `
                <div class="interaction-row">
                    <span class="text-[10px] text-gray-400 w-8 font-mono">${verb}</span>
                    <select class="form-select text-[10px] h-5 p-0 w-16 bg-black ia-type" onchange="updateRoomData()">
                        <option value="text" ${data.type==='text'?'selected':''}>Msg</option>
                        <option value="move" ${data.type==='move'?'selected':''}>Move</option>
                        <option value="script" ${data.type==='script'?'selected':''}>Code</option>
                    </select>
                    <input class="form-input text-[10px] h-5 p-0 px-1 flex-1 bg-black ia-value" value="${data.value||''}" onchange="updateRoomData()">
                    <button onclick="this.parentElement.remove();updateRoomData()" class="text-red-500 font-bold px-1 text-[10px]">×</button>
                </div>
            `).join('');

            return `
                <input class="form-input text-xs mb-1 obj-id-name" value="${val}" placeholder="Name (e.g. rusty lever)" onchange="updateRoomData()">
                <input class="form-input text-xs mb-1 obj-keys" value="${(obj.keywords||[]).join(',')}" placeholder="Keywords (lever, rusty)" onchange="updateRoomData()">
                <textarea class="form-textarea text-xs h-10 mb-1 obj-desc" placeholder="Description" onchange="updateRoomData()">${obj.description||''}</textarea>
                <div class="mt-1">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] text-gray-500">INTERACTIONS</span>
                        <button onclick="addInteractionRow(this)" class="text-[10px] text-blue-400">+ Add</button>
                    </div>
                    <div class="interactions-list space-y-1">${interactionsHtml}</div>
                </div>
            `;
        } else {
            // Reference Types (Monster/Item/Node)
            const listId = `dl-${type}s`;
            return `
                <label class="form-label">Asset ID</label>
                <input class="form-input text-xs obj-id-name text-green-400" list="${listId}" value="${val}" placeholder="Search ${type}..." onchange="updateRoomData()">
            `;
        }
    }

    window.changeObjType = function(select) {
        const type = select.value;
        const body = select.closest('.object-card').querySelector('.obj-body');
        body.innerHTML = renderObjectBody(type, "", {});
        updateRoomData();
    };

    window.addInteractionRow = function(btn) {
        const container = btn.parentElement.nextElementSibling;
        const div = document.createElement('div');
        div.className = 'interaction-row';
        div.innerHTML = `
            <input class="form-input text-[10px] h-5 p-0 w-12 bg-black ia-verb" placeholder="verb" onchange="updateRoomData()">
            <select class="form-select text-[10px] h-5 p-0 w-16 bg-black ia-type" onchange="updateRoomData()">
                <option value="text">Msg</option>
                <option value="move">Move</option>
                <option value="script">Code</option>
            </select>
            <input class="form-input text-[10px] h-5 p-0 px-1 flex-1 bg-black ia-value" placeholder="Value" onchange="updateRoomData()">
            <button onclick="this.parentElement.remove();updateRoomData()" class="text-red-500 font-bold px-1 text-[10px]">×</button>
        `;
        container.appendChild(div);
    };

    function addExitRow() {
        document.getElementById('exits-list').appendChild(createExitRow());
    }
    
    function addObjectRow() {
        document.getElementById('objects-list').appendChild(createObjectCard({name:""}));
    }

    // --- SAVING DATA ---

    function updateRoomData() {
        const r = getActiveRoomObj();
        if (!r) return;
        
        r.room_id = document.getElementById('room_id').value;
        r.name = document.getElementById('name').value;
        r.x = parseInt(document.getElementById('x').value) || 0;
        r.y = parseInt(document.getElementById('y').value) || 0;
        r.z = parseInt(document.getElementById('z').value) || 0;
        r.description.default = document.getElementById('desc').value;
        r.is_outdoor = document.getElementById('is_outdoor').checked;
        
        // Save Exits
        r.exits = {};
        document.querySelectorAll('.exit-row').forEach(row => {
            const dir = row.querySelector('.exit-dir').value.trim();
            const target = row.querySelector('.exit-target').value.trim();
            if (dir && target) r.exits[dir] = target;
        });

        // Save Objects
        r.objects = [];
        document.querySelectorAll('.object-row').forEach(row => {
            const type = row.querySelector('.obj-type').value;
            const val = row.querySelector('.obj-id-name').value.trim();
            if (!val) return;

            let newObj = {};
            if (type === 'static') {
                newObj.name = val;
                newObj.description = row.querySelector('.obj-desc').value;
                const keys = row.querySelector('.obj-keys').value;
                newObj.keywords = keys ? keys.split(',') : val.toLowerCase().split(' ');
                newObj.verbs = ["look"];
                
                // Interactions
                const interactions = {};
                row.querySelectorAll('.interaction-row').forEach(ir => {
                    const v = ir.querySelector('.ia-verb')?.value || ir.querySelector('span')?.innerText; // Handle both input and span cases
                    const t = ir.querySelector('.ia-type').value;
                    const d = ir.querySelector('.ia-value').value;
                    if (v) {
                        interactions[v] = { type: t, value: d };
                        newObj.verbs.push(v);
                    }
                });
                if (Object.keys(interactions).length > 0) newObj.interactions = interactions;
            } else {
                if (type === 'monster') { newObj.monster_id = val; newObj.is_monster = true; }
                else if (type === 'item') { newObj.item_id = val; newObj.is_item = true; }
                else if (type === 'node') { newObj.node_id = val; newObj.is_gathering_node = true; }
            }
            r.objects.push(newObj);
        });

        renderMap();
    }

    // --- MAP RENDERING ---
    function renderMap() {
        const svg = document.getElementById('map-content');
        svg.innerHTML = '';
        
        // Draw Links First (Background)
        Object.values(projectData).forEach(zone => {
            zone.rooms.forEach(r => {
                if (!isoMode && r.z !== currentZ) return;
                const start = getScreenCoords(r.x, r.y, r.z, zone.offset);
                
                Object.entries(r.exits).forEach(([dir, targetId]) => {
                    const targetInfo = findRoomGlobal(targetId);
                    if (targetInfo) {
                        if (!isoMode && targetInfo.room.z !== currentZ) return;
                        const end = getScreenCoords(targetInfo.room.x, targetInfo.room.y, targetInfo.room.z, targetInfo.zone.offset);
                        drawLink(svg, start, end, targetInfo.file !== activeRoom?.file);
                    }
                });
            });
        });

        // Draw Zones & Rooms
        Object.entries(projectData).forEach(([filename, zone]) => {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.classList.add('zone-group');
            
            // Zone Background for Dragging
            if (zone.rooms.length > 0) {
                let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
                let hasVisibleRooms = false;
                zone.rooms.forEach(r => {
                    if (!isoMode && r.z !== currentZ) return;
                    hasVisibleRooms = true;
                    const c = getScreenCoords(r.x, r.y, r.z, zone.offset);
                    minX = Math.min(minX, c.x); maxX = Math.max(maxX, c.x);
                    minY = Math.min(minY, c.y); maxY = Math.max(maxY, c.y);
                });

                if (hasVisibleRooms) {
                    const pad = 30;
                    const bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    bg.setAttribute("x", minX - pad); bg.setAttribute("y", minY - pad);
                    bg.setAttribute("width", maxX - minX + pad*2 + ROOM_SIZE);
                    bg.setAttribute("height", maxY - minY + pad*2 + ROOM_SIZE);
                    bg.classList.add("zone-bg");
                    bg.onmousedown = (e) => startZoneDrag(e, filename);
                    
                    const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    label.setAttribute("x", minX - pad); label.setAttribute("y", minY - pad - 5);
                    label.textContent = filename;
                    label.classList.add("zone-label");
                    
                    g.appendChild(bg); g.appendChild(label);
                }
            }

            // Rooms
            zone.rooms.forEach((r, i) => {
                if (!isoMode && r.z !== currentZ) return;
                const c = getScreenCoords(r.x, r.y, r.z, zone.offset);
                
                const rg = document.createElementNS("http://www.w3.org/2000/svg", "g");
                rg.classList.add("map-room");
                if (activeRoom?.file === filename && activeRoom?.index === i) rg.classList.add("current");
                
                rg.onclick = (e) => { e.stopPropagation(); setActiveRoom(filename, i); };
                rg.oncontextmenu = (e) => { e.preventDefault(); openContextMenu(e, r, filename); };

                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", c.x); rect.setAttribute("y", c.y);
                rect.setAttribute("width", ROOM_SIZE); rect.setAttribute("height", ROOM_SIZE);
                
                // Simple ISO depth effect
                if (isoMode) {
                    const depth = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    depth.setAttribute("d", `M ${c.x} ${c.y+ROOM_SIZE} L ${c.x} ${c.y+ROOM_SIZE+5} L ${c.x+ROOM_SIZE} ${c.y+ROOM_SIZE+5} L ${c.x+ROOM_SIZE} ${c.y+ROOM_SIZE} Z`);
                    depth.setAttribute("fill", "#222");
                    rg.appendChild(depth);
                }

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", c.x + ROOM_SIZE/2); text.setAttribute("y", c.y + ROOM_SIZE/2 + 3);
                text.textContent = r.room_id.substring(0, 3);

                rg.appendChild(rect); rg.appendChild(text);
                g.appendChild(rg);
            });
            svg.appendChild(g);
        });
    }

    function getScreenCoords(x, y, z, offset) {
        let sx, sy;
        if (isoMode) {
            sx = (x - y) * (CELL_SIZE * 0.8);
            sy = (x + y) * (CELL_SIZE * 0.4) - (z * CELL_SIZE * 1.5);
        } else {
            sx = x * CELL_SIZE;
            sy = -y * CELL_SIZE;
        }
        return { x: sx + offset.x, y: sy + offset.y };
    }

    function drawLink(parent, p1, p2, isCross) {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", p1.x + ROOM_SIZE/2); line.setAttribute("y1", p1.y + ROOM_SIZE/2);
        line.setAttribute("x2", p2.x + ROOM_SIZE/2); line.setAttribute("y2", p2.y + ROOM_SIZE/2);
        line.classList.add("map-link");
        if (isCross) line.classList.add("cross-zone");
        parent.insertBefore(line, parent.firstChild);
    }

    function findRoomGlobal(id) {
        for (const [file, data] of Object.entries(projectData)) {
            const r = data.rooms.find(r => r.room_id === id);
            if (r) return { room: r, file: file, zone: data };
        }
        return null;
    }

    // --- INTERACTION ---
    function startPan(e) {
        if (e.target.tagName !== 'svg') return;
        isDraggingMap = true;
        dragStart = { x: e.clientX, y: e.clientY };
        document.body.style.cursor = "grabbing";
        
        const move = (ev) => {
            pan.x += ev.clientX - dragStart.x;
            pan.y += ev.clientY - dragStart.y;
            dragStart = { x: ev.clientX, y: ev.clientY };
            updateTransform();
        };
        const up = () => {
            isDraggingMap = false;
            document.body.style.cursor = "default";
            window.removeEventListener('mousemove', move);
            window.removeEventListener('mouseup', up);
        };
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
    }

    function startZoneDrag(e, filename) {
        e.stopPropagation();
        dragStart = { x: e.clientX, y: e.clientY };
        
        const move = (ev) => {
            projectData[filename].offset.x += (ev.clientX - dragStart.x) / scale;
            projectData[filename].offset.y += (ev.clientY - dragStart.y) / scale;
            dragStart = { x: ev.clientX, y: ev.clientY };
            renderMap();
        };
        const up = () => {
            window.removeEventListener('mousemove', move);
            window.removeEventListener('mouseup', up);
        };
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
    }

    function handleZoom(e) {
        e.preventDefault();
        scale *= e.deltaY > 0 ? 0.9 : 1.1;
        updateTransform();
    }
    
    function updateTransform() {
        document.getElementById('map-content').setAttribute('transform', `translate(${pan.x}, ${pan.y}) scale(${scale})`);
    }

    // --- UTILS ---
    function quickBuild(dir, dx, dy, dz=0) {
        if (!activeRoom) return;
        const r = getActiveRoomObj();
        const zone = projectData[activeRoom.file];
        
        const tx = r.x+dx, ty = r.y+dy, tz = r.z+dz;
        let target = zone.rooms.find(xr => xr.x===tx && xr.y===ty && xr.z===tz);
        
        if (!target) {
            createRoom(activeRoom.file, tx, ty, tz);
            target = zone.rooms[zone.rooms.length-1];
        }
        
        r.exits[dir] = target.room_id;
        const backMap = {north:'south',south:'north',east:'west',west:'east',northeast:'southwest',southwest:'northeast',northwest:'southeast',southeast:'northwest',up:'down',down:'up'};
        if (backMap[dir]) target.exits[backMap[dir]] = r.room_id;
        
        updateRoomData();
        setActiveRoom(activeRoom.file, activeRoom.index);
    }

    function setIsoMode(val) {
        isoMode = val;
        document.getElementById('btn-2d').classList.toggle('active', !val);
        document.getElementById('btn-3d').classList.toggle('active', val);
        document.getElementById('z-level-slider').disabled = val;
        renderMap();
    }

    function updateZDisplay() {
        currentZ = parseInt(document.getElementById('z-level-slider').value);
        document.getElementById('z-display').innerText = currentZ;
        renderMap();
    }

    function openContextMenu(e, room, filename) {
        contextTarget = { room, filename };
        const m = document.getElementById('context-menu');
        m.style.display = 'block';
        m.style.left = e.clientX + 'px'; m.style.top = e.clientY + 'px';
        const hide = () => { m.style.display = 'none'; window.removeEventListener('click', hide); };
        window.addEventListener('click', hide);
    }

    function actionAddInterior() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.add('hidden');
        document.getElementById('interior-modal').classList.remove('hidden');
        const rid = contextTarget.room.room_id;
        document.getElementById('int-filename').value = `zones/interiors/${rid}_int.json`;
        document.getElementById('int-id').value = `${rid}_inside`;
    }

    function confirmAddInterior() {
        const fname = document.getElementById('int-filename').value;
        const intId = document.getElementById('int-id').value;
        const rName = document.getElementById('int-room-name').value;
        
        createZone(fname);
        const newZone = projectData[fname];
        const newRoom = newZone.rooms[0];
        newRoom.name = rName;
        newRoom.interior_id = intId;
        newRoom.room_id = `${intId}_entry`;
        
        const source = contextTarget.room;
        source.exits[`enter ${intId}`] = newRoom.room_id;
        newRoom.exits["out"] = source.room_id;
        
        // Position new zone
        const srcZone = projectData[contextTarget.filename];
        newZone.offset.x = srcZone.offset.x + 200;
        newZone.offset.y = srcZone.offset.y + 50;
        
        closeModal();
        renderMap();
        updateRoomData();
    }

    // --- IO ---
    function openLoadModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.remove('hidden');
        document.getElementById('interior-modal').classList.add('hidden');
        fetch('/api/zones').then(r=>r.json()).then(files => {
            document.getElementById('server-file-list').innerHTML = files.map(f => `<option value="${f}">${f}</option>`).join('');
        });
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    async function loadSelectedFile() {
        const file = document.getElementById('server-file-list').value;
        if (!file) return;
        const res = await fetch(`/api/load?file=${encodeURIComponent(file)}`);
        const data = await res.json();
        projectData[file] = { rooms: data, offset: { x: Object.keys(projectData).length*250, y:50 } };
        updateFileList(); renderMap(); closeModal();
        if (data.length) setActiveRoom(file, 0);
    }

    async function saveAllZones() {
        const payload = {};
        Object.entries(projectData).forEach(([f, d]) => payload[f] = d.rooms);
        const res = await fetch('/api/save_batch', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({files:payload}) });
        const ret = await res.json();
        alert(ret.results.join('\n'));
    }

    function updateFileList() {
        const c = document.getElementById('loaded-files-container');
        c.innerHTML = Object.keys(projectData).map(f => `
            <div class="zone-entry">
                <span title="${f}">${f}</span>
                <span class="text-[10px] bg-gray-800 px-1 rounded">${projectData[f].rooms.length}</span>
            </div>
        `).join('');
    }
    
    function createNewZoneFile() {
        const name = prompt("Filename:");
        if(name) createZone(name);
    }
    
    function deleteRoom() {
        if(!activeRoom) return;
        const z = projectData[activeRoom.file];
        z.rooms.splice(activeRoom.index, 1);
        activeRoom = null;
        document.getElementById('room-editor').classList.add('hidden');
        renderMap();
    }
</script>
</body>
</html>