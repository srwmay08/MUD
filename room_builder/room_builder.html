<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Visual Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e5e5e5; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2a2a2a; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        #main-container { display: flex; height: 100vh; }
        #editor-panel { width: 50%; overflow-y: auto; padding: 1.5rem; border-right: 1px solid #333; background: #222; }
        #visual-panel { width: 50%; display: flex; flex-direction: column; background: #111; position: relative; }
        #map-container { flex-grow: 1; overflow: hidden; cursor: grab; position: relative; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; }
        #map-container:active { cursor: grabbing; }
        .map-room rect { fill: #333; stroke: #666; stroke-width: 1; transition: fill 0.2s; cursor: pointer; }
        .map-room:hover rect { fill: #444; stroke: #888; }
        .map-room.current rect { fill: #f59e0b; stroke: #fff; stroke-width: 2; }
        .map-room text { font-size: 8px; fill: #aaa; text-anchor: middle; pointer-events: none; font-family: monospace; }
        .map-room.current text { fill: #000; font-weight: bold; }
        .map-link { stroke: #555; stroke-width: 1; }
        .form-section { background: #2a2a2a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #333; }
        .form-section-title { font-size: 1.1rem; font-weight: 700; color: #f59e0b; border-bottom: 1px solid #444; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 0.2rem; }
        .form-input, .form-textarea, .form-select { width: 100%; background: #151515; border: 1px solid #444; color: #fff; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.9rem; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #f59e0b; }
        .dynamic-item { background: #1f1f1f; padding: 0.75rem; border-radius: 0.25rem; border: 1px solid #333; margin-bottom: 0.5rem; }
        .btn { padding: 0.4rem 0.8rem; border-radius: 0.25rem; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #f59e0b; color: #000; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-secondary { background: #3b82f6; color: #fff; }
        .btn-neutral { background: #4b5563; color: #fff; }
        .btn-success { background: #10b981; color: #fff; }
        
        /* Modal Overlay */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 50; align-items: center; justify-content: center; }
        .modal-box { background: #222; padding: 2rem; border-radius: 0.5rem; border: 1px solid #444; width: 400px; max-width: 90%; }
        
        /* Room List Overlay */
        #room-list-overlay {
            position: absolute; top: 10px; right: 10px; width: 200px; max-height: 300px;
            background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 0.5rem;
            overflow-y: auto; padding: 0.5rem; z-index: 10; pointer-events: auto;
        }
        .room-list-item { padding: 4px 8px; cursor: pointer; font-size: 0.85rem; border-radius: 4px; color: #ccc; }
        .room-list-item:hover { background: #333; color: #fff; }
        .room-list-item.active { background: #f59e0b; color: #000; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="editor-panel">
        <div class="flex justify-between items-center mb-6 bg-black/20 p-2 rounded">
            <h1 class="text-xl font-bold text-amber-500">Room Architect</h1>
            <div class="space-x-2">
                <button onclick="showLoadModal()" class="btn btn-neutral text-xs">üìÇ Load Server File</button>
                <button onclick="showSaveModal()" class="btn btn-success text-xs">üíæ Save to Server</button>
                <button onclick="newZone()" class="btn btn-danger text-xs">Clear</button>
                <button onclick="createNewRoom()" class="btn btn-secondary text-xs">+ Room</button>
            </div>
        </div>

        <form id="room-form">
            <div class="form-section">
                <h2 class="form-section-title">Core</h2>
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div><label class="form-label">Room ID</label><input type="text" id="room_id" class="form-input font-mono text-amber-500" oninput="updateCurrentRoomState()"></div>
                    <div><label class="form-label">Name</label><input type="text" id="name" class="form-input" oninput="updateCurrentRoomState()"></div>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div><label class="form-label">X</label><input type="number" id="x" class="form-input" oninput="updateCurrentRoomState()"></div>
                    <div><label class="form-label">Y</label><input type="number" id="y" class="form-input" oninput="updateCurrentRoomState()"></div>
                    <div><label class="form-label">Z</label><input type="number" id="z" class="form-input" oninput="updateCurrentRoomState()"></div>
                    <div><label class="form-label">Zone</label><input type="text" id="interior_id" class="form-input" oninput="updateCurrentRoomState()"></div>
                </div>
                <div class="mt-3"><label class="flex items-center space-x-2"><input type="checkbox" id="is_outdoor" class="w-4 h-4" onchange="updateCurrentRoomState()"><span class="text-sm text-gray-300">Is Outdoor?</span></label></div>
            </div>

            <div class="form-section border-blue-900 bg-blue-900/20">
                <h2 class="form-section-title text-blue-400 text-sm">Quick Build</h2>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('northwest', -1, 1)">NW</button>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('north', 0, 1)">N</button>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('northeast', 1, 1)">NE</button>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('west', -1, 0)">W</button>
                    <div class="text-center text-gray-500 flex items-center justify-center">‚óè</div>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('east', 1, 0)">E</button>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('southwest', -1, -1)">SW</button>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('south', 0, -1)">S</button>
                    <button type="button" class="btn btn-neutral p-1" onclick="quickBuild('southeast', 1, -1)">SE</button>
                </div>
            </div>

            <div class="form-section">
                <h2 class="form-section-title">Description</h2>
                <textarea id="desc_default" class="form-textarea h-24" oninput="updateCurrentRoomState()"></textarea>
            </div>

            <div class="form-section">
                <div class="flex justify-between items-center mb-2"><h2 class="form-section-title border-0 m-0">Exits</h2><button type="button" onclick="addExitUI()" class="text-xs text-amber-500">+ Add</button></div>
                <div id="exits-container"></div>
            </div>
            
            <div class="form-section">
                <div class="flex justify-between items-center mb-2"><h2 class="form-section-title border-0 m-0">Objects</h2><button type="button" onclick="addObjectUI()" class="text-xs text-amber-500">+ Add</button></div>
                <div id="objects-container"></div>
            </div>
        </form>
    </div>

    <div id="visual-panel">
        <div id="room-list-overlay">
            <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Zone Rooms</h3>
            <div id="room-list-content"></div>
        </div>

        <div id="map-container" onwheel="handleZoom(event)" onmousedown="startPan(event)">
            <svg id="map-svg" width="100%" height="100%" style="transform-origin: 0 0;">
                <g id="map-links"></g>
                <g id="map-nodes"></g>
            </svg>
        </div>
        <div class="bg-black p-2 text-xs text-gray-500 flex justify-between border-t border-gray-800">
            <span id="status-filename">File: Unsaved</span>
            <span id="status-count">0 Rooms</span>
        </div>
    </div>
</div>

<div id="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div id="load-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-4">Load Zone from Server</h2>
        <select id="server-file-list" class="form-select mb-4 text-sm font-mono"></select>
        <div class="flex justify-end space-x-2">
            <button onclick="document.getElementById('modal-overlay').style.display='none'" class="btn btn-neutral">Cancel</button>
            <button onclick="loadFromServer()" class="btn btn-primary">Load</button>
        </div>
    </div>
    <div id="save-modal" class="modal-box hidden">
        <h2 class="text-lg font-bold text-white mb-4">Save Zone to Server</h2>
        <label class="form-label">Filename (relative to mud_backend/data/)</label>
        <input type="text" id="save-filename" class="form-input mb-4 font-mono" placeholder="my_new_zone.json">
        <div class="flex justify-end space-x-2">
            <button onclick="document.getElementById('modal-overlay').style.display='none'" class="btn btn-neutral">Cancel</button>
            <button onclick="saveToServer()" class="btn btn-success">Save</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let zoneRooms = [];
    let activeRoomId = null;
    let currentFilename = "";
    let scale = 1, panX = 0, panY = 0, isPanning = false, startPanX = 0, startPanY = 0;

    window.onload = () => {
        const c = document.getElementById('map-container');
        panX = c.clientWidth / 2; panY = c.clientHeight / 2;
        updateMapTransform();
        createNewRoom("start", 0, 0, 0);
    };
    
    // --- HELPER: Safe Normalize ---
    function normalizeRoom(r) {
        // Force numbers. If it's "10" string, parse it. If null, 0.
        r.x = parseInt(r.x) || 0;
        r.y = parseInt(r.y) || 0;
        r.z = parseInt(r.z) || 0;
        if(!r.description) r.description = { default: "" };
        if(!r.exits) r.exits = {};
        if(!r.objects) r.objects = [];
        if(r.interior_id === undefined || r.interior_id === null) r.interior_id = "";
        return r;
    }

    // --- SERVER API ---
    async function showLoadModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('load-modal').classList.remove('hidden');
        document.getElementById('save-modal').classList.add('hidden');
        
        const res = await fetch('/api/zones');
        const files = await res.json();
        const select = document.getElementById('server-file-list');
        select.innerHTML = '';
        files.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f; opt.innerText = f; select.appendChild(opt);
        });
    }

    async function loadFromServer() {
        const filename = document.getElementById('server-file-list').value;
        if (!filename) return;
        
        try {
            const res = await fetch(`/api/load?file=${encodeURIComponent(filename)}`);
            if (!res.ok) throw new Error("Failed to load");
            const data = await res.json();
            
            // Normalize EVERY room immediately
            zoneRooms = data.map(r => normalizeRoom(r));
            
            currentFilename = filename;
            document.getElementById('status-filename').innerText = `File: ${filename}`;
            document.getElementById('modal-overlay').style.display = 'none';

            if (zoneRooms.length > 0) loadRoomIntoEditor(zoneRooms[0].room_id);
            renderRoomList();
            renderMap();
        } catch (e) {
            alert("Error loading file: " + e);
        }
    }

    function showSaveModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('save-modal').classList.remove('hidden');
        document.getElementById('load-modal').classList.add('hidden');
        if (currentFilename) document.getElementById('save-filename').value = currentFilename;
    }

    async function saveToServer() {
        const filename = document.getElementById('save-filename').value;
        if (!filename) return alert("Filename required");
        
        try {
            // Ensure all data is clean before saving
            const cleanRooms = zoneRooms.map(r => normalizeRoom(r));
            
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename, rooms: cleanRooms })
            });
            const result = await res.json();
            if (result.success) {
                alert("Saved successfully!");
                currentFilename = filename;
                document.getElementById('status-filename').innerText = `File: ${filename}`;
                document.getElementById('modal-overlay').style.display = 'none';
            } else {
                alert("Error: " + result.error);
            }
        } catch (e) {
            alert("Save failed: " + e);
        }
    }

    // --- BUILDER LOGIC ---
    function createNewRoom(id=null, x=0, y=0, z=0) {
        const newId = id || `room_${Date.now()}`;
        const newRoom = { room_id: newId, name: "New Room", x, y, z, description: { default: "Desc" }, exits: {}, objects: [], interior_id: "" };
        zoneRooms.push(normalizeRoom(newRoom));
        loadRoomIntoEditor(newId);
        renderRoomList();
        renderMap();
    }

    function loadRoomIntoEditor(id) {
        activeRoomId = id;
        const r = zoneRooms.find(rm => rm.room_id === id);
        if (!r) return;
        
        document.getElementById('room_id').value = r.room_id;
        document.getElementById('name').value = r.name;
        document.getElementById('x').value = r.x;
        document.getElementById('y').value = r.y;
        document.getElementById('z').value = r.z;
        document.getElementById('interior_id').value = r.interior_id || "";
        document.getElementById('is_outdoor').checked = !!r.is_outdoor;
        document.getElementById('desc_default').value = r.description.default || "";
        
        const exCont = document.getElementById('exits-container'); exCont.innerHTML = '';
        if(r.exits) Object.entries(r.exits).forEach(([k,v]) => addExitUI(k,v));
        
        const objCont = document.getElementById('objects-container'); objCont.innerHTML = '';
        if(r.objects) r.objects.forEach(o => addObjectUI(o));
        
        updateStatus();
        renderRoomList(); // Highlight active
        renderMap();
    }

    function updateCurrentRoomState() {
        if (!activeRoomId) return;
        const r = zoneRooms.find(rm => rm.room_id === activeRoomId);
        if (!r) return;
        
        const newId = document.getElementById('room_id').value;
        if (newId !== activeRoomId) { r.room_id = newId; activeRoomId = newId; }
        
        r.name = document.getElementById('name').value;
        // FORCE INT PARSING
        r.x = parseInt(document.getElementById('x').value)||0;
        r.y = parseInt(document.getElementById('y').value)||0;
        r.z = parseInt(document.getElementById('z').value)||0;
        r.interior_id = document.getElementById('interior_id').value;
        r.is_outdoor = document.getElementById('is_outdoor').checked;
        r.description = { default: document.getElementById('desc_default').value };
        
        r.exits = {};
        document.querySelectorAll('.exit-item').forEach(el => {
            const d = el.querySelector('.exit-dir').value;
            const t = el.querySelector('.exit-target').value;
            if(d && t) r.exits[d] = t;
        });
        
        r.objects = [];
        document.querySelectorAll('.object-item').forEach(el => {
            const n = el.querySelector('.obj-name').value;
            if(n) r.objects.push({ name: n, keywords: el.querySelector('.obj-keys').value.split(',') });
        });
        
        renderMap();
        renderRoomList();
    }

    function quickBuild(dir, dx, dy) {
        if(!activeRoomId) return;
        const cur = zoneRooms.find(r => r.room_id === activeRoomId);
        
        // FORCE INT PARSING HERE TOO just in case
        const curX = parseInt(cur.x)||0;
        const curY = parseInt(cur.y)||0;
        const curZ = parseInt(cur.z)||0;

        const nx = curX + dx;
        const ny = curY + dy;
        const nz = curZ;
        
        // Looser equality check for Interior ID (handle null vs empty string)
        const exist = zoneRooms.find(r => r.x===nx && r.y===ny && r.z===nz && (r.interior_id||"")===(cur.interior_id||""));
        
        if(exist) {
            addExitUI(dir, exist.room_id);
            updateCurrentRoomState();
            const backMap = {'north':'south','south':'north','east':'west','west':'east','northeast':'southwest','southwest':'northeast','northwest':'southeast','southeast':'northwest'};
            const back = backMap[dir.toLowerCase()];
            if(back && !exist.exits[back]) exist.exits[back] = cur.room_id;
        } else {
            const nid = `room_${nx}_${ny}_${nz}`;
            addExitUI(dir, nid);
            updateCurrentRoomState();
            const backMap = {'north':'south','south':'north','east':'west','west':'east','northeast':'southwest','southwest':'northeast','northwest':'southeast','southeast':'northwest'};
            const back = backMap[dir.toLowerCase()];
            
            const newR = { room_id: nid, name: "New Room", x: nx, y: ny, z: nz, interior_id: cur.interior_id||"", description:{default:""}, exits:{}, objects:[] };
            if(back) newR.exits[back] = cur.room_id;
            zoneRooms.push(normalizeRoom(newR));
            loadRoomIntoEditor(nid);
        }
    }

    function newZone() { if(confirm("Clear?")) { zoneRooms=[]; createNewRoom(); } }
    
    // --- UI HELPERS ---
    function addExitUI(d='', t='') {
        const div = document.createElement('div'); div.className = 'dynamic-item exit-item flex gap-2';
        div.innerHTML = `<input class="form-input exit-dir w-1/3" value="${d}" placeholder="Dir" oninput="updateCurrentRoomState()"><input class="form-input exit-target w-1/2" value="${t}" placeholder="Target" oninput="updateCurrentRoomState()"><button onclick="this.parentElement.remove();updateCurrentRoomState()" class="text-red-500">x</button>`;
        document.getElementById('exits-container').appendChild(div);
    }
    function addObjectUI(o={}) {
        const div = document.createElement('div'); div.className = 'dynamic-item object-item mb-2';
        div.innerHTML = `<div class="flex justify-between text-xs text-gray-400"><span>Obj</span><button onclick="this.closest('.object-item').remove();updateCurrentRoomState()" class="text-red-500">x</button></div><input class="form-input obj-name mb-1" value="${o.name||''}" placeholder="Name" oninput="updateCurrentRoomState()"><input class="form-input obj-keys" value="${(o.keywords||[]).join(',')}" placeholder="Keywords" oninput="updateCurrentRoomState()">`;
        document.getElementById('objects-container').appendChild(div);
    }
    function updateStatus() { document.getElementById('status-count').innerText = zoneRooms.length + " Rooms"; }
    function renderRoomList() {
        const c = document.getElementById('room-list-content'); c.innerHTML='';
        zoneRooms.forEach(r => {
            const d = document.createElement('div'); d.className=`room-list-item ${r.room_id===activeRoomId?'active':''}`;
            d.innerText = `${r.room_id} (${r.x},${r.y},${r.z})`;
            d.onclick = () => loadRoomIntoEditor(r.room_id);
            c.appendChild(d);
        });
    }

    // --- MAP RENDERER ---
    function renderMap() {
        const ng = document.getElementById('map-nodes'), lg = document.getElementById('map-links');
        ng.innerHTML = ''; lg.innerHTML = '';
        const CELL = 30, GAP = 10, UNIT = CELL+GAP, coords = {};
        
        const active = zoneRooms.find(r => r.room_id === activeRoomId);
        // SAFE FILTER: Allow if active is missing, or if Z matches. Treat null interior as ""
        const activeZ = active ? (active.z||0) : 0;
        const activeInt = active ? (active.interior_id||"") : "";

        zoneRooms.forEach(r => {
            // Filter by Z and Interior (Zone)
            if((r.z||0) !== activeZ) return;
            if((r.interior_id||"") !== activeInt) return;

            try {
                const rx = (r.x||0)*UNIT, ry = -(r.y||0)*UNIT; // Negate Y for screen coords
                coords[r.room_id] = {x: rx+CELL/2, y: ry+CELL/2};
                
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", `map-room ${r.room_id === activeRoomId ? 'current' : ''}`);
                g.onclick = () => loadRoomIntoEditor(r.room_id);
                
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", rx); rect.setAttribute("y", ry);
                rect.setAttribute("width", CELL); rect.setAttribute("height", CELL);
                rect.setAttribute("rx", 4);
                
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", rx+CELL/2); txt.setAttribute("y", ry+CELL/2+3);
                // Safety check for substring
                const idStr = String(r.room_id || "???");
                txt.textContent = idStr.substring(0,5);
                
                g.appendChild(rect); g.appendChild(txt); ng.appendChild(g);
            } catch(err) {
                console.warn("Error rendering room:", r, err);
            }
        });
        
        // Draw links separately so they are under nodes
        zoneRooms.forEach(r => {
            const p1 = coords[r.room_id];
            if(!p1 || !r.exits) return;
            
            Object.values(r.exits).forEach(tid => {
                const p2 = coords[tid];
                if(p2) {
                    const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    l.setAttribute("x1", p1.x); l.setAttribute("y1", p1.y);
                    l.setAttribute("x2", p2.x); l.setAttribute("y2", p2.y);
                    l.setAttribute("class", "map-link");
                    lg.appendChild(l);
                }
            });
        });
    }
    
    function updateMapTransform() { document.getElementById('map-svg').style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; }
    function handleZoom(e) { e.preventDefault(); scale += e.deltaY * -0.001; scale = Math.min(Math.max(0.1, scale), 4); updateMapTransform(); }
    function startPan(e) { isPanning=true; startPanX=e.clientX-panX; startPanY=e.clientY-panY; document.addEventListener('mousemove', doPan); document.addEventListener('mouseup', endPan); }
    function doPan(e) { if(!isPanning) return; panX=e.clientX-startPanX; panY=e.clientY-startPanY; updateMapTransform(); }
    function endPan() { isPanning=false; document.removeEventListener('mousemove', doPan); document.removeEventListener('mouseup', endPan); }

</script>
</body>
</html>