<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MUD Entity Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #121212; color: #e5e5e5; height: 100vh; overflow: hidden; display: flex; font-family: sans-serif; }
        .panel { padding: 1rem; display: flex; flex-direction: column; height: 100%; border-right: 1px solid #333; }
        .scroll-y { overflow-y: auto; flex-grow: 1; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        input, select, textarea { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 4px 8px; border-radius: 4px; width: 100%; font-family: monospace; font-size: 0.9rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #f59e0b; }
        
        label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; margin-top: 8px; display: block; }
        
        .list-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .list-item:hover { background: #222; }
        .list-item.active { background: #f59e0b; color: #000; }
        
        .btn { padding: 4px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: 0.2s; }
        .btn-primary { background: #f59e0b; color: #000; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-neutral { background: #374151; color: #fff; }
        
        .group-box { border: 1px solid #333; padding: 8px; border-radius: 4px; background: #181818; margin-top: 4px; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }

        /* FM-Style Preset Grid */
        .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }
        .preset-card { 
            background: #1f2937; border: 1px solid #374151; padding: 8px; border-radius: 6px; 
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .preset-card:hover { border-color: #f59e0b; background: #374151; }
        .preset-card h4 { font-size: 0.75rem; font-weight: bold; color: #f59e0b; margin-bottom: 2px; }
        .preset-card p { font-size: 0.65rem; color: #9ca3af; line-height: 1.1; }
        
    </style>
</head>
<body>

<div class="panel" style="width: 250px; background: #0a0a0a;">
    <h1 class="text-amber-500 font-bold text-xl mb-4">Entity Architect</h1>
    
    <div class="mb-4">
        <label>Category</label>
        <select id="category-select" onchange="loadFileList()">
            <option value="monsters">Monsters & NPCs</option>
            <option value="items">Items</option>
            <option value="spells">Magic Spells</option>
            <option value="nodes">Gathering Nodes</option>
            <option value="loot">Loot Tables</option>
            <option value="quests">Quests</option>
            <option value="global">Global Config</option> </select>
    </div>

    <div class="mb-4 flex-grow flex flex-col">
        <label>Files</label>
        <select id="file-select" class="flex-grow" size="10" onchange="loadFile()"></select>
    </div>

    <div class="flex gap-2">
        <button onclick="saveFile()" class="btn btn-primary w-full">Save File</button>
    </div>
</div>

<div class="panel" style="width: 300px; background: #121212;">
    <div class="flex justify-between items-center mb-2">
        <h2 class="font-bold text-gray-300">Entities</h2>
        <button onclick="createEntity()" class="btn btn-neutral text-xs">+ New</button>
    </div>
    <input type="text" id="search-box" placeholder="Filter..." class="mb-2" oninput="renderEntityList()">
    <div id="entity-list" class="scroll-y"></div>
</div>

<div class="panel flex-grow" style="background: #181818; padding: 0;">
    <div id="editor-header" class="p-4 border-b border-gray-700 flex justify-between bg-black/20">
        <span id="editor-title" class="text-lg font-bold text-gray-400">Select an entity</span>
        <button onclick="deleteEntity()" class="btn btn-danger hidden" id="delete-btn">Delete</button>
    </div>
    <div id="form-container" class="scroll-y p-6 hidden"></div>
</div>

<datalist id="dl-items"></datalist>
<datalist id="dl-loot"></datalist>
<datalist id="dl-spells"></datalist>

<script>
    let currentCategory = "monsters";
    let currentData = null; 
    let isDictStructure = false; 
    let activeEntityId = null; 
    let activeFilename = "";
    let refs = { skills: [], items: [], loot_tables: [], spells: [], slots: [], factions: [] };

    // --- AI PRESETS (FM Style) ---
    const AI_PRESETS = [
        { 
            name: "Aggressive Melee", 
            desc: "Attacks anything nearby.",
            block: { conditions: [], action: { type: "attack", value: "" } }
        },
        { 
            name: "Self Preservation", 
            desc: "Flees if HP < 20%.",
            block: { conditions: [{ type: "health_below_percent", value: "20" }], action: { type: "flee", value: "" } }
        },
        { 
            name: "Pack Healer", 
            desc: "Casts Heal on Low HP Allies.",
            block: { conditions: [{ type: "has_ally_low_hp", value: "50" }], action: { type: "cast", value: "heal_1" } }
        },
        { 
            name: "Execute Weak", 
            desc: "Target Low HP Enemies.",
            block: { conditions: [{ type: "target_health_below_percent", value: "20" }], action: { type: "attack", value: "" } }
        },
        { 
            name: "Defensive Caster", 
            desc: "Buff self if not buffed.",
            block: { conditions: [{ type: "self_status_missing", value: "shielded" }], action: { type: "cast", value: "shield_1" } }
        },
        { 
            name: "Caster Assault", 
            desc: "Casts spell at target.",
            block: { conditions: [], action: { type: "cast", value: "shock_1" } }
        }
    ];

    window.onload = async () => { 
        await fetchReferences();
        loadFileList(); 
    };

    async function fetchReferences() {
        try {
            const res = await fetch('/api/references');
            refs = await res.json();
            const populate = (id, list) => {
                document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join('');
            };
            populate('dl-items', refs.items);
            populate('dl-loot', refs.loot_tables);
            populate('dl-spells', refs.spells);
        } catch (e) { console.error("Ref load error", e); }
    }

    async function loadFileList() {
        currentCategory = document.getElementById('category-select').value;
        const res = await fetch('/api/files');
        const files = await res.json();
        const select = document.getElementById('file-select');
        select.innerHTML = '';
        (files[currentCategory] || []).forEach(f => {
            const opt = document.createElement('option');
            opt.value = f; opt.innerText = f; select.appendChild(opt);
        });
        document.getElementById('form-container').classList.add('hidden');
    }

    async function loadFile() {
        activeFilename = document.getElementById('file-select').value;
        if(!activeFilename) return;
        const res = await fetch(`/api/load?file=${encodeURIComponent(activeFilename)}`);
        const json = await res.json();
        if(json.error) return alert(json.error);
        
        currentData = json.data;
        isDictStructure = json.is_dict;
        activeEntityId = null;
        renderEntityList();
        document.getElementById('form-container').classList.add('hidden');
        document.getElementById('delete-btn').classList.add('hidden');
        document.getElementById('editor-title').innerText = activeFilename;
    }

    async function saveFile() {
        if(!activeFilename || !currentData) return;
        const res = await fetch('/api/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ filename: activeFilename, data: currentData })
        });
        const result = await res.json();
        if(result.success) alert("Saved!"); else alert("Error: " + result.error);
    }

    function renderEntityList() {
        const container = document.getElementById('entity-list');
        container.innerHTML = '';
        const filter = document.getElementById('search-box').value.toLowerCase();
        
        let keys = isDictStructure ? Object.keys(currentData) : currentData.map((_, i) => i);

        keys.forEach(key => {
            let entity = currentData[key];
            let name = entity.name || key;
            let idDisplay = isDictStructure ? key : (entity.monster_id || entity.node_id || key);
            if(currentCategory === 'loot') idDisplay = `(${entity.length} items)`;

            if(String(name).toLowerCase().includes(filter) || String(idDisplay).toLowerCase().includes(filter)) {
                const div = document.createElement('div');
                div.className = `list-item ${key == activeEntityId ? 'active' : ''}`;
                div.innerHTML = `<span>${name}</span><span class="text-gray-500 text-xs">${idDisplay}</span>`;
                div.onclick = () => loadEntity(key);
                container.appendChild(div);
            }
        });
    }

    function loadEntity(key) {
        activeEntityId = key;
        renderEntityList();
        const entity = currentData[key];
        const container = document.getElementById('form-container');
        container.innerHTML = '';
        container.classList.remove('hidden');
        document.getElementById('delete-btn').classList.remove('hidden');

        // Key Field
        if (isDictStructure) {
            container.appendChild(createInput("ID (Key)", key, (val) => {
                if (val !== activeEntityId && val) {
                    currentData[val] = currentData[activeEntityId];
                    delete currentData[activeEntityId];
                    activeEntityId = val;
                    renderEntityList();
                }
            }));
        } else {
            const idField = currentCategory === 'monsters' ? 'monster_id' : (currentCategory === 'nodes' ? 'node_id' : 'id');
            if(entity[idField] !== undefined) {
                container.appendChild(createInput(`${idField} (Unique)`, entity[idField], (v) => updateField(idField, v)));
            }
        }

        if (currentCategory === 'loot') {
            renderLootFields(container, entity);
        } else if (currentCategory === 'quests') {
            renderQuestFields(container, entity);
        } else if (currentCategory === 'global') {
            // Generic JSON Editor for Globals
            renderGlobalFields(container, entity);
        } else {
            // Common
            container.appendChild(createInput("Name", entity.name || "", (v) => updateField("name", v)));
            container.appendChild(createInput("Description", entity.description || "", (v) => updateField("description", v)));
            container.appendChild(createInput("Keywords (csv)", (entity.keywords || []).join(', '), (v) => updateField("keywords", v.split(',').map(s=>s.trim()).filter(s=>s))));

            if (currentCategory === 'monsters') renderMonsterFields(container, entity);
            else if (currentCategory === 'items') renderItemFields(container, entity);
            else if (currentCategory === 'spells') renderSpellFields(container, entity);
            else if (currentCategory === 'nodes') renderNodeFields(container, entity);
        }
    }

    function updateField(field, value) {
        currentData[activeEntityId][field] = value;
        if(field === 'name') renderEntityList();
    }

    function createEntity() {
        if(!currentData) return;
        let newObj = { name: "New Entity", description: "..." };
        let newKey = "";

        if (currentCategory === 'monsters') {
            newObj.monster_id = "new_mob_" + Date.now();
            newObj.level = 1; newObj.is_monster = true;
            newObj.stats = {STR:50, CON:50, DEX:50, AGI:50, LOG:10, INT:10, WIS:10, INF:10, ZEA:10, ESS:10, DIS:10, AUR:10};
            if(!isDictStructure) currentData.push(newObj);
        } else if (currentCategory === 'items') {
            newKey = "new_item_" + Date.now();
            newObj.item_type = "component"; newObj.base_value = 10;
            currentData[newKey] = newObj;
        } else if (currentCategory === 'spells') {
            newKey = "new_spell_" + Date.now();
            newObj.school = "elemental"; newObj.effect = "attack";
            currentData[newKey] = newObj;
        } else if (currentCategory === 'nodes') {
            newKey = "new_node_" + Date.now();
            newObj.node_id = newKey; newObj.node_type = "mining";
            currentData[newKey] = newObj;
        } else if (currentCategory === 'loot') {
            newKey = "loot_" + Date.now();
            currentData[newKey] = [];
        } else if (currentCategory === 'quests') {
            newKey = "quest_" + Date.now();
            newObj.archetype = "standard";
            currentData[newKey] = newObj;
        } else if (currentCategory === 'global') {
            newKey = "new_global_" + Date.now();
            currentData[newKey] = {};
        }
        
        if (!isDictStructure && currentCategory !== 'monsters') {
             // Fallback
        } else if (!isDictStructure && currentCategory === 'monsters') {
             loadEntity(currentData.length - 1);
        } else {
             loadEntity(newKey);
        }
        renderEntityList();
    }

    function deleteEntity() {
        if(activeEntityId === null || !confirm("Delete?")) return;
        if(isDictStructure) delete currentData[activeEntityId];
        else currentData.splice(activeEntityId, 1);
        activeEntityId = null;
        document.getElementById('form-container').classList.add('hidden');
        renderEntityList();
    }

    // --- Renderers ---

    function createInput(label, value, onChange, listId=null) {
        const div = document.createElement('div');
        div.className = "mb-2";
        div.innerHTML = `<label>${label}</label>`;
        const input = document.createElement('input');
        input.value = value;
        if(listId) input.setAttribute('list', listId);
        input.oninput = (e) => onChange(e.target.value);
        div.appendChild(input);
        return div;
    }

    function createSelect(label, value, options, onChange) {
        const div = document.createElement('div');
        div.className = "mb-2";
        div.innerHTML = `<label>${label}</label>`;
        const sel = document.createElement('select');
        options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.innerText = opt;
            if(opt === value) o.selected = true;
            sel.appendChild(o);
        });
        sel.onchange = (e) => onChange(e.target.value);
        div.appendChild(sel);
        return div;
    }

    function createCheckbox(label, checked, onChange) {
        const div = document.createElement('div');
        div.className = "mb-2 flex items-center gap-2";
        const input = document.createElement('input');
        input.type = "checkbox"; input.style.width = "auto"; input.checked = checked;
        input.onchange = (e) => onChange(e.target.checked);
        div.appendChild(input);
        div.innerHTML += `<span class="text-sm font-bold text-gray-400 uppercase">${label}</span>`;
        return div;
    }

    function createListEditor(label, array, onChange, listId=null) {
        if(!array) array = [];
        const wrapper = document.createElement('div');
        wrapper.className = "group-box mb-2";
        wrapper.innerHTML = `<label>${label}</label><div class="l-list"></div><button class="btn btn-neutral text-xs mt-1">+ Add</button>`;
        const list = wrapper.querySelector('.l-list');
        
        const render = () => {
            list.innerHTML = '';
            array.forEach((val, idx) => {
                const row = document.createElement('div');
                row.className = "flex gap-1 mb-1";
                const inp = document.createElement('input');
                inp.className = "text-xs";
                inp.value = val;
                if(listId) inp.setAttribute('list', listId);
                inp.onchange = (e) => { array[idx] = e.target.value; onChange(array); };
                
                const btn = document.createElement('button');
                btn.className = "text-red-500 px-2 font-bold";
                btn.innerText = "×";
                btn.onclick = () => { array.splice(idx, 1); onChange(array); render(); };
                
                row.appendChild(inp); row.appendChild(btn); list.appendChild(row);
            });
        };
        wrapper.querySelector('button').onclick = () => { array.push(""); onChange(array); render(); };
        render();
        return wrapper;
    }

    function createKeyValueEditor(label, dataObj, onChange, keyOptions=null, valueListId=null) {
        if (!dataObj) dataObj = {}; 
        const wrapper = document.createElement('div');
        wrapper.className = "group-box mb-2";
        wrapper.innerHTML = `<label>${label}</label><div class="kv-list"></div><button class="btn btn-neutral text-xs mt-1">+ Add</button>`;
        const list = wrapper.querySelector('.kv-list');
        
        const render = () => {
            list.innerHTML = '';
            Object.entries(dataObj).forEach(([k, v]) => {
                const row = document.createElement('div');
                row.className = "flex gap-1 mb-1";
                
                let kInp;
                if (keyOptions) {
                    kInp = document.createElement('select');
                    kInp.className = "w-1/2 text-xs bg-[#1a1a1a] border border-[#333] text-white";
                    keyOptions.forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt; o.innerText = opt;
                        if(opt === k) o.selected = true;
                        kInp.appendChild(o);
                    });
                } else {
                    kInp = document.createElement('input'); 
                    kInp.className = "w-1/2 text-xs"; 
                    kInp.value = k; 
                }

                const vInp = document.createElement('input'); 
                vInp.className = "w-1/2 text-xs"; 
                vInp.value = v; 
                if(valueListId) vInp.setAttribute('list', valueListId);
                
                const btn = document.createElement('button'); 
                btn.className = "text-red-500 px-2 font-bold"; btn.innerText = "×";
                
                kInp.onchange = (e) => { 
                    if(e.target.value && e.target.value !== k) { 
                        if (dataObj[e.target.value] !== undefined && e.target.value !== k) {
                            alert("That key already exists.");
                            render(); // Reset UI
                            return;
                        }
                        dataObj[e.target.value] = dataObj[k]; 
                        delete dataObj[k]; 
                        onChange(dataObj); 
                        render(); 
                    }
                };
                vInp.onchange = (e) => { 
                    const val = e.target.value; 
                    dataObj[k] = isNaN(val) ? val : (val.trim()==="" ? "" : parseFloat(val)); 
                    onChange(dataObj);
                };
                btn.onclick = () => { delete dataObj[k]; onChange(dataObj); render(); };
                
                row.appendChild(kInp); row.appendChild(vInp); row.appendChild(btn); list.appendChild(row);
            });
        };
        
        wrapper.querySelector('button').onclick = () => { 
            let initialKey = "";
            if (keyOptions) {
                // Find first unused key
                initialKey = keyOptions.find(opt => dataObj[opt] === undefined) || keyOptions[0];
            } else {
                let i=1; while(dataObj[`new_${i}`]) i++; 
                initialKey = `new_${i}`;
            }
            
            if (dataObj[initialKey] !== undefined) {
                alert("Cannot add more: All keys used or conflict.");
                return;
            }

            dataObj[initialKey] = ""; 
            onChange(dataObj); 
            render(); 
        };
        render();
        return wrapper;
    }

    function createAIScriptEditor(label, scriptArray, onChange) {
        if (!scriptArray) scriptArray = [];
        const wrapper = document.createElement('div');
        wrapper.className = "group-box mb-2 border-amber-500/50";
        wrapper.innerHTML = `<label class="text-amber-500">${label}</label><div class="preset-container mb-4"></div><div class="script-list space-y-2"></div><button class="btn btn-neutral text-xs mt-2">+ Add Empty Block</button>`;
        
        const presetContainer = wrapper.querySelector('.preset-container');
        presetContainer.innerHTML = `<div class="text-[10px] text-gray-500 mb-1 uppercase tracking-wide">Tactical Presets</div><div class="preset-grid"></div>`;
        const grid = presetContainer.querySelector('.preset-grid');
        
        AI_PRESETS.forEach(preset => {
            const card = document.createElement('div');
            card.className = "preset-card";
            card.innerHTML = `<h4>${preset.name}</h4><p>${preset.desc}</p>`;
            card.onclick = () => {
                const newBlock = JSON.parse(JSON.stringify(preset.block));
                scriptArray.push(newBlock);
                onChange(scriptArray);
                render();
            };
            grid.appendChild(card);
        });

        const list = wrapper.querySelector('.script-list');

        const render = () => {
            list.innerHTML = '';
            scriptArray.forEach((block, idx) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = "bg-gray-900 p-2 rounded border border-gray-700";
                
                let condHtml = `<div class="mb-1 text-xs text-gray-400">Conditions</div><div class="cond-list pl-2 border-l border-gray-600 mb-2"></div>`;
                condHtml += `<button class="text-[10px] text-green-400 hover:text-green-300" onclick="addCond(${idx})">+ Condition</button>`;
                
                let actHtml = `<div class="mb-1 text-xs text-gray-400 mt-2">Action</div>`;
                actHtml += `<div class="flex gap-1"><select class="act-type text-xs w-1/3 bg-gray-800 border-none"><option value="attack">Attack</option><option value="cast">Cast</option><option value="flee">Flee</option><option value="switch_target">Switch Target</option></select>`;
                actHtml += `<input class="act-val text-xs w-2/3 bg-gray-800 border-none" placeholder="Value (Spell ID, etc)" value="${block.action?.value || ''}"></div>`;

                blockDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-gray-300">Block #${idx+1}</span>
                        <button class="text-red-500 font-bold" onclick="removeBlock(${idx})">×</button>
                    </div>
                    ${condHtml}
                    ${actHtml}
                `;

                const condList = blockDiv.querySelector('.cond-list');
                (block.conditions || []).forEach((c, cIdx) => {
                    const row = document.createElement('div');
                    row.className = "flex gap-1 mb-1";
                    row.innerHTML = `
                        <select class="c-type text-[10px] w-1/2 bg-gray-800 border-none" onchange="updateCond(${idx}, ${cIdx}, 'type', this.value)">
                            <option value="health_below_percent" ${c.type==='health_below_percent'?'selected':''}>My HP < %</option>
                            <option value="target_health_below_percent" ${c.type==='target_health_below_percent'?'selected':''}>Target HP < %</option>
                            <option value="target_status" ${c.type==='target_status'?'selected':''}>Target Status</option>
                            <option value="has_ally_low_hp" ${c.type==='has_ally_low_hp'?'selected':''}>Ally HP < %</option>
                            <option value="self_status_missing" ${c.type==='self_status_missing'?'selected':''}>Missing Status</option>
                        </select>
                        <input class="c-val text-[10px] w-1/3 bg-gray-800 border-none" value="${c.value||''}" placeholder="Value" onchange="updateCond(${idx}, ${cIdx}, 'value', this.value)">
                        <button class="text-red-500 font-bold px-1" onclick="removeCond(${idx}, ${cIdx})">×</button>
                    `;
                    condList.appendChild(row);
                });

                const actType = blockDiv.querySelector('.act-type');
                actType.value = block.action?.type || "attack";
                actType.onchange = (e) => { 
                    if(!block.action) block.action = {}; 
                    block.action.type = e.target.value; 
                    onChange(scriptArray); 
                };
                
                const actVal = blockDiv.querySelector('.act-val');
                actVal.onchange = (e) => { 
                    if(!block.action) block.action = {}; 
                    block.action.value = e.target.value; 
                    onChange(scriptArray); 
                };

                list.appendChild(blockDiv);
            });
        };

        window.addCond = (bIdx) => {
            if(!scriptArray[bIdx].conditions) scriptArray[bIdx].conditions = [];
            scriptArray[bIdx].conditions.push({type: "health_below_percent", value: "50"});
            onChange(scriptArray); render();
        };
        window.removeCond = (bIdx, cIdx) => {
            scriptArray[bIdx].conditions.splice(cIdx, 1);
            onChange(scriptArray); render();
        };
        window.updateCond = (bIdx, cIdx, key, val) => {
            scriptArray[bIdx].conditions[cIdx][key] = val;
            onChange(scriptArray);
        };
        window.removeBlock = (bIdx) => {
            scriptArray.splice(bIdx, 1);
            onChange(scriptArray); render();
        };

        wrapper.querySelector('button.mt-2').onclick = () => {
            scriptArray.push({ conditions: [], action: {type: "attack", value: ""} });
            onChange(scriptArray); render();
        };

        render();
        return wrapper;
    }

    function renderMonsterFields(container, entity) {
        const flagDiv = document.createElement('div');
        flagDiv.className = "flex flex-wrap gap-4 mb-2";
        flagDiv.appendChild(createCheckbox("Is NPC", !!entity.is_npc, (v) => updateField("is_npc", v)));
        flagDiv.appendChild(createCheckbox("Aggressive", !!entity.is_aggressive, (v) => updateField("is_aggressive", v)));
        flagDiv.appendChild(createCheckbox("Undead", !!entity.is_undead, (v) => updateField("is_undead", v)));
        flagDiv.appendChild(createCheckbox("Non-Corporeal", !!entity.is_non_corporeal, (v) => updateField("is_non_corporeal", v)));
        flagDiv.appendChild(createCheckbox("BCS", !!entity.bcs, (v) => updateField("bcs", v)));
        container.appendChild(flagDiv);

        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 gap-4 mb-2";
        grid.appendChild(createInput("Level", entity.level || 1, (v) => updateField("level", parseInt(v))));
        grid.appendChild(createInput("Max HP", entity.max_hp || 50, (v) => updateField("max_hp", parseInt(v))));
        
        // --- UPDATED: Faction Dropdown ---
        container.appendChild(createSelect("Faction", entity.faction || "Townsfolk", refs.factions, (v) => updateField("faction", v)));
        
        grid.appendChild(createInput("Family", entity.family || "Human", (v) => updateField("family", v)));
        grid.appendChild(createInput("Body Type", entity.body_type || "biped", (v) => updateField("body_type", v)));
        grid.appendChild(createInput("Perception DC", entity.perception_dc || 0, (v) => updateField("perception_dc", parseInt(v))));
        container.appendChild(grid);

        const grid2 = document.createElement('div');
        grid2.className = "grid grid-cols-3 gap-4 mb-2 bg-black/20 p-2 rounded border border-gray-700";
        grid2.appendChild(createInput("Action Timer (s)", entity.action_timer_seconds || 5, (v) => updateField("action_timer_seconds", parseFloat(v))));
        grid2.appendChild(createInput("Respawn Time (s)", entity.respawn_time_seconds || 300, (v) => updateField("respawn_time_seconds", parseFloat(v))));
        grid2.appendChild(createInput("Respawn Chance", entity.respawn_chance_per_tick || 0.2, (v) => updateField("respawn_chance_per_tick", parseFloat(v))));
        container.appendChild(grid2);

        const rangeDiv = document.createElement('div');
        rangeDiv.innerHTML = `<label>Level Range (Min, Max)</label>`;
        const rangeInp = document.createElement('input');
        rangeInp.value = (entity.level_range || []).join(', ');
        rangeInp.onchange = (e) => updateField("level_range", e.target.value.split(',').map(n => parseInt(n.trim())));
        rangeDiv.appendChild(rangeInp);
        container.appendChild(rangeDiv);
        
        // --- NEW: Faction Adjustment Editor ---
        container.appendChild(createKeyValueEditor("Faction Adjustments on Death", entity.faction_adjustments_on_death || {}, (v) => updateField("faction_adjustments_on_death", v), refs.factions));

        container.appendChild(createInput("Spawn Arrival", entity.spawn_message_arrival || "", (v) => updateField("spawn_message_arrival", v)));
        container.appendChild(createInput("Spawn Departure", entity.spawn_message_departure || "", (v) => updateField("spawn_message_departure", v)));

        container.appendChild(createAIScriptEditor("AI Behavior Strategy", entity.ai_script || [], (v) => updateField("ai_script", v)));

        container.appendChild(createListEditor("Attack Attributes (Natural)", entity.attack_attributes || [], (v) => updateField("attack_attributes", v)));
        
        container.appendChild(createKeyValueEditor("Skills (Name: Rank)", entity.skills || {}, (v) => updateField("skills", v), refs.skills));
        
        container.appendChild(createKeyValueEditor("Equipped (Slot: ItemID)", entity.equipped || {}, (v) => updateField("equipped", v), refs.slots, "dl-items"));
        
        container.appendChild(createListEditor("Known Spells", entity.known_spells || [], (v) => updateField("known_spells", v), "dl-spells"));

        const statBox = document.createElement('div');
        statBox.className = "group-box";
        statBox.innerHTML = "<label>Stats</label><div class='stat-grid' id='stat-grid'></div>";
        const statGrid = statBox.querySelector('#stat-grid');
        const stats = entity.stats || {STR:50, CON:50, DEX:50, AGI:50, LOG:10, INT:10, WIS:10, INF:10, ZEA:10, ESS:10, DIS:10, AUR:10};
        Object.keys(stats).forEach(stat => {
            const div = document.createElement('div');
            div.innerHTML = `<span class='text-xs text-amber-500'>${stat}</span>`;
            const inp = document.createElement('input');
            inp.type = "number"; inp.value = stats[stat]; inp.className = "text-center";
            inp.onchange = (e) => { stats[stat] = parseInt(e.target.value); updateField("stats", stats); };
            div.appendChild(inp);
            statGrid.appendChild(div);
        });
        container.appendChild(statBox);
        container.appendChild(createInput("Loot Table ID", entity.loot_table_id || "", (v) => updateField("loot_table_id", v), "dl-loot"));
    }

    function renderGlobalFields(container, entity) {
        container.appendChild(createKeyValueEditor("Raw JSON Data", entity, (v) => {
            // Update currentData directly because entity IS currentData[key] here
            // But this KV editor modifies in place
        }));
        // Actually, for global config, it's best to just expose the raw JSON structure in a text area
        // or a specialized editor. Since we don't have a schema for every global file,
        // a simple text area fallback is safest for now.
        const ta = document.createElement('textarea');
        ta.className = "h-96 font-mono text-xs";
        ta.value = JSON.stringify(entity, null, 2);
        ta.onchange = (e) => {
            try {
                const parsed = JSON.parse(e.target.value);
                // Update the object reference in currentData
                currentData[activeEntityId] = parsed;
            } catch(err) {
                alert("Invalid JSON");
            }
        };
        container.appendChild(ta);
    }

    function renderSpellFields(container, entity) {
        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 gap-4 mb-2";
        grid.appendChild(createSelect("School", entity.school || "elemental", ["elemental", "spiritual", "mental", "sorcery"], (v) => updateField("school", v)));
        grid.appendChild(createSelect("Effect", entity.effect || "attack", ["attack", "heal", "buff", "dispel", "utility"], (v) => updateField("effect", v)));
        container.appendChild(grid);

        const grid2 = document.createElement('div');
        grid2.className = "grid grid-cols-3 gap-4 mb-2";
        grid2.appendChild(createInput("Mana Cost", entity.mana_cost || 0, (v) => updateField("mana_cost", parseInt(v))));
        grid2.appendChild(createInput("Spirit Cost", entity.spirit_cost || 0, (v) => updateField("spirit_cost", parseInt(v))));
        grid2.appendChild(createInput("Base Power", entity.base_power || 10, (v) => updateField("base_power", parseInt(v))));
        container.appendChild(grid2);

        container.appendChild(createInput("Skill Used", entity.skill || "harness_power", (v) => updateField("skill", v), "dl-skills"));
        container.appendChild(createInput("Cast Msg (Self)", entity.cast_message_self || "", (v) => updateField("cast_message_self", v)));
        container.appendChild(createInput("Cast Msg (Room)", entity.cast_message_room || "", (v) => updateField("cast_message_room", v)));
        
        if (entity.effect === "attack") {
            container.appendChild(createInput("Damage Type", entity.damage_type || "impact", (v) => updateField("damage_type", v)));
            container.appendChild(createInput("Damage Factor", entity.base_damage_factor || 0.2, (v) => updateField("base_damage_factor", parseFloat(v))));
        } else if (entity.effect === "buff") {
            container.appendChild(createInput("Buff Type", entity.buff_type || "ds_bonus", (v) => updateField("buff_type", v)));
            container.appendChild(createInput("Duration Per Rank", entity.duration_per_rank || 10, (v) => updateField("duration_per_rank", parseInt(v))));
        }
    }

    function renderItemFields(container, entity) {
        container.appendChild(createSelect("Item Type", entity.item_type, ["weapon", "armor", "shield", "container", "tool", "component", "gem", "jewelry", "ore", "herb", "quest"], (v) => updateField("item_type", v)));
        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 gap-4";
        grid.appendChild(createInput("Base Value", entity.base_value || 0, (v) => updateField("base_value", parseInt(v))));
        // --- UPDATED: Pass slots here too for Item wearable_slot ---
        const slotsWithEmpty = [""].concat(refs.slots || []);
        container.appendChild(createSelect("Slot", entity.wearable_slot || "", slotsWithEmpty, (v) => updateField("wearable_slot", v)));
        
        container.appendChild(grid);
        if(entity.item_type === "weapon") {
            container.appendChild(createInput("Skill", entity.skill || "brawling", (v) => updateField("skill", v), "dl-skills"));
        }
    }

    function renderNodeFields(container, entity) {
        container.appendChild(createSelect("Node Type", entity.node_type, ["mining", "herbalism", "lumberjacking", "fishing"], (v) => updateField("node_type", v)));
        container.appendChild(createInput("Skill DC", entity.skill_dc || 20, (v) => updateField("skill_dc", parseInt(v))));
        container.appendChild(createInput("Loot Table ID", entity.loot_table_id || "", (v) => updateField("loot_table_id", v), "dl-loot"));
        container.appendChild(createInput("Default Taps", entity.default_taps || 1, (v) => updateField("default_taps", parseInt(v))));
    }

    function renderLootFields(container, lootList) {
        const wrapper = document.createElement('div');
        wrapper.className = "group-box";
        wrapper.innerHTML = `<label>Loot Entries</label><div class="loot-list"></div><button class="btn btn-neutral text-xs mt-1">+ Add Item</button>`;
        const list = wrapper.querySelector('.loot-list');
        const render = () => {
            list.innerHTML = '';
            lootList.forEach((entry, idx) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 mb-2 items-center bg-black/30 p-2 rounded";
                const itemInp = document.createElement('input'); itemInp.className="flex-grow text-xs"; itemInp.placeholder="Item ID"; itemInp.setAttribute('list','dl-items'); itemInp.value=entry.item_id||""; itemInp.onchange=(e)=>{entry.item_id=e.target.value;};
                const chanceInp = document.createElement('input'); chanceInp.type="number"; chanceInp.className="w-16 text-xs text-center"; chanceInp.step=0.01; chanceInp.value=entry.chance||1.0; chanceInp.onchange=(e)=>{entry.chance=parseFloat(e.target.value);};
                const qtyInp = document.createElement('input'); qtyInp.className="w-20 text-xs text-center"; qtyInp.value=Array.isArray(entry.quantity)?entry.quantity.join(','):entry.quantity; qtyInp.onchange=(e)=>{ const v=e.target.value; entry.quantity=v.includes(',')?v.split(',').map(n=>parseInt(n)):parseInt(v); };
                const delBtn = document.createElement('button'); delBtn.className="text-red-500 font-bold"; delBtn.innerText="×"; delBtn.onclick=()=>{ lootList.splice(idx,1); render(); };
                row.appendChild(itemInp); row.appendChild(chanceInp); row.appendChild(qtyInp); row.appendChild(delBtn); list.appendChild(row);
            });
        };
        wrapper.querySelector('button').onclick=()=>{ lootList.push({item_id:"", chance:1.0, quantity:1}); render(); };
        render(); container.appendChild(wrapper);
    }

    function renderQuestFields(container, quest) {
        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 gap-4 mb-2";
        grid.appendChild(createInput("Quest Name", quest.name || "", (v) => updateField("name", v)));
        grid.appendChild(createSelect("Archetype", quest.archetype || "standard", 
            ["standard", "syntax_kill", "social_duel", "cartographer", "burden", "crafting"], 
            (v) => { updateField("archetype", v); loadEntity(activeEntityId); } 
        ));
        container.appendChild(grid);

        const archetype = quest.archetype || "standard";
        const specificsDiv = document.createElement('div');
        specificsDiv.className = "bg-gray-800 p-2 rounded border border-gray-600 mb-2";
        
        specificsDiv.innerHTML = `<div class="text-xs text-amber-500 font-bold uppercase mb-2">${archetype.replace('_',' ')} Config</div>`;

        if (archetype === "syntax_kill") {
            specificsDiv.appendChild(createInput("Target Monster ID", quest.monster_id || "", (v) => updateField("monster_id", v)));
            specificsDiv.appendChild(createInput("Req. Counter Key", quest.req_counter || "", (v) => updateField("req_counter", v)));
            specificsDiv.appendChild(createInput("Required Kill Source (physical/spell)", quest.required_kill_method?.source || "", (v) => {
                let m = quest.required_kill_method || {}; m.source = v; updateField("required_kill_method", m);
            }));
            specificsDiv.appendChild(createInput("Required Source ID (item/spell ID)", quest.required_kill_method?.id || "", (v) => {
                let m = quest.required_kill_method || {}; m.id = v; updateField("required_kill_method", m);
            }));
        } 
        else if (archetype === "social_duel") {
            specificsDiv.appendChild(createInput("Target NPC Name/ID", quest.social_target_id || "", (v) => updateField("social_target_id", v)));
            specificsDiv.appendChild(createSelect("Required Action", quest.social_action_type || "bribe", 
                ["bribe", "threaten", "plead", "flatter"], 
                (v) => updateField("social_action_type", v)));
            specificsDiv.appendChild(createInput("Successes Needed", quest.req_counter_value || 1, (v) => updateField("req_counter_value", parseInt(v))));
        }
        else if (archetype === "cartographer") {
            specificsDiv.appendChild(createListEditor("Room IDs to Visit", quest.required_rooms_visited || [], (v) => updateField("required_rooms_visited", v)));
        }
        else if (archetype === "burden") {
            specificsDiv.appendChild(createInput("Burden Item ID", quest.burden_item_id || "", (v) => updateField("burden_item_id", v)));
            specificsDiv.appendChild(createInput("Destination Room ID", quest.destination_room_id || "", (v) => updateField("destination_room_id", v)));
        }
        else if (archetype === "crafting") {
             specificsDiv.appendChild(createInput("Crafted Item ID", quest.crafted_item_id || "", (v) => updateField("crafted_item_id", v)));
             specificsDiv.appendChild(createInput("Quantity", quest.crafted_item_quantity || 1, (v) => updateField("crafted_item_quantity", parseInt(v))));
        }
        else {
            specificsDiv.appendChild(createInput("Item Needed", quest.item_needed || "", (v) => updateField("item_needed", v), "dl-items"));
            specificsDiv.appendChild(createInput("Quantity", quest.item_quantity || 1, (v) => updateField("item_quantity", parseInt(v))));
            specificsDiv.appendChild(createInput("Give Target (NPC Name)", quest.give_target_name || "", (v) => updateField("give_target_name", v)));
        }

        container.appendChild(specificsDiv);

        container.appendChild(createInput("Reward XP", quest.reward_xp || 0, (v) => updateField("reward_xp", parseInt(v))));
        container.appendChild(createSelect("Reward XP Type", quest.reward_xp_type || "field", ["field", "instant"], (v) => updateField("reward_xp_type", v)));
        container.appendChild(createInput("Reward Silver", quest.reward_silver || 0, (v) => updateField("reward_silver", parseInt(v))));
        container.appendChild(createInput("Reward Item", quest.reward_item || "", (v) => updateField("reward_item", v), "dl-items"));
        
        container.appendChild(createInput("Start/Idle Prompt", quest.idle_prompt || "", (v) => updateField("idle_prompt", v)));
        container.appendChild(createInput("Talk Prompt", quest.talk_prompt || "", (v) => updateField("talk_prompt", v)));
        container.appendChild(createInput("Reward Message", quest.reward_message || "", (v) => updateField("reward_message", v)));
    }
</script>
</body>
</html>