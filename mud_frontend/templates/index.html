<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Client</title>
    <style>
        /* All your styles are unchanged... */
        body {
            font-family: 'Lucida Console', 'Courier New', monospace;
            background: #000;
            color: #CCC;
            margin: 0;
            padding: 20px;
        }
        #output {
            width: 100%;
            height: 500px;
            border: 1px solid #333;
            overflow-y: scroll;
            padding: 10px;
            box-sizing: border-box;
            white-space: pre-wrap;
            line-height: 1.5;
            background: #0a0a0a;
        }
        .room-title { color: #61bfff; font-weight: bold; }
        .keyword { color: #f0c674; text-decoration: underline; cursor: pointer; }
        .command-echo { color: #888; }
        #input-line { display: flex; margin-top: 10px; }
        #input-line > span { padding-right: 10px; color: #CCC; }
        #command-input {
            flex-grow: 1;
            background: #000;
            color: #0F0;
            border: none;
            font-family: 'Lucida Console', 'Courier New', monospace;
        }
        #command-input:focus { outline: none; }
        #context-menu {
            display: none;
            position: absolute;
            background-color: #2c2c2c;
            border: 1px solid #888;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            min-width: 150px;
            z-index: 1000;
        }
        #context-menu div {
            padding: 8px 12px;
            color: #DDD;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        #context-menu div:last-child { border-bottom: none; }
        #context-menu div:hover { background-color: #4a4a4a; color: #FFF; }
    </style>
</head>
<body>
    <div id="output">Please enter your character name to create or load a character.</div>
    
    <div id="input-line">
        <span>&gt;</span>
        <input type="text" id="command-input" autofocus>
    </div>

    <div id="context-menu"></div>

    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('command-input');
        const contextMenu = document.getElementById('context-menu');
        
        let activeKeyword = null;
        
        // NEW: We add a variable to store the player's name
        let playerName = null;

        // --- Helper: Send Command to Backend ---
        // MODIFIED: This function now takes the player's name as an argument
        async function sendCommand(command, name) {
            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_name: name, // Use the name passed to the function
                        command: command
                    })
                });
                
                const data = await response.json();
                
                // Display the server's response
                data.messages.forEach(msg => addMessage(msg));

            } catch (error) {
                addMessage(`Error: Could not connect to server. ${error}`);
            }
        }

        // --- Helper: Add Message to Output (Unchanged) ---
        function addMessage(message, messageClass = null) {
            let formattedMessage = message;
            formattedMessage = formattedMessage.replace(
                /\*\*(.*?)\*\*/g, 
                '<span class="room-title">[$1]</span>'
            );
            if (messageClass) {
                formattedMessage = `<span class="${messageClass}">${formattedMessage}</span>`;
            }
            output.innerHTML += `\n${formattedMessage}`;
            output.scrollTop = output.scrollHeight;
        }

        // --- Input: Listen for "Enter" key ---
        // MODIFIED: This logic is new. It checks if we are logged in or not.
        input.addEventListener('keydown', async function(event) {
            if (event.key === 'Enter') {
                const commandOrName = input.value;
                if (!commandOrName) return;

                // Clear the input box
                input.value = '';

                if (playerName === null) {
                    // --- 1. This is the LOGIN/CREATE step ---
                    playerName = commandOrName;
                    
                    // Show a welcome message
                    addMessage(`> Welcome, ${playerName}. Loading character...`, 'command-echo');
                    
                    // Send an automatic 'look' command to log in / create
                    await sendCommand('look', playerName);
                    
                } else {
                    // --- 2. This is a NORMAL game command ---
                    
                    // Display the command you typed
                    addMessage(`> ${commandOrName}`, 'command-echo');
                    
                    // Send the command
                    await sendCommand(commandOrName, playerName);
                }
            }
        });

        // --- Right-Click Menu: Show Menu (Unchanged) ---
        output.addEventListener('contextmenu', function(event) {
            const target = event.target;
            if (target.classList.contains('keyword')) {
                event.preventDefault(); 
                activeKeyword = target.dataset.name || target.innerText;
                const verbs = (target.dataset.verbs || "look").split(',');
                
                contextMenu.innerHTML = ''; 
                verbs.forEach(verb => {
                    const item = document.createElement('div');
                    item.innerText = `${verb} ${activeKeyword}`;
                    item.dataset.command = `${verb} ${activeKeyword}`;
                    contextMenu.appendChild(item);
                });

                contextMenu.style.left = `${event.pageX}px`;
                contextMenu.style.top = `${event.pageY}px`;
                contextMenu.style.display = 'block';
            }
        });

        // --- Right-Click Menu: Hide Menu (Unchanged) ---
        document.addEventListener('click', function(event) {
            if (contextMenu.style.display === 'block') {
                contextMenu.style.display = 'none';
            }
        });

        // --- Right-Click Menu: Handle Click on Menu Item ---
        // MODIFIED: We must send the 'playerName' with the command
        contextMenu.addEventListener('click', function(event) {
            const command = event.target.dataset.command;
            if (command && playerName) { // Check that we are logged in
                input.value = ''; 
                addMessage(`> ${command}`, 'command-echo'); // Echo the command
                sendCommand(command, playerName); // Send the command (e.g., "look fountain")
            }
        });

    </script>
</body>
</html>