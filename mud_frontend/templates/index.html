<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUD Client</title>
    <style>
        body {
            font-family: 'Lucida Console', 'Courier New', monospace;
            background: #000;
            color: #CCC; /* Default text color */
            margin: 0;
            padding: 20px;
        }

        #output {
            width: 100%;
            height: 500px;
            border: 1px solid #333;
            overflow-y: scroll;
            padding: 10px;
            box-sizing: border-box;
            white-space: pre-wrap; /* Preserves newlines */
            line-height: 1.5;
            background: #0a0a0a;
        }

        /* Style for room titles, like [Icemule Trace] */
        .room-title {
            color: #61bfff; /* Bright Blue */
            font-weight: bold;
        }
        
        /* Style for keywords (objects, players, monsters) */
        .keyword {
            color: #f0c674; /* Yellow/Gold */
            text-decoration: underline;
            cursor: pointer;
        }
        
        /* Style for your own typed commands */
        .command-echo {
            color: #888;
        }

        #input-line {
            display: flex;
            margin-top: 10px;
        }
        
        #input-line > span {
            padding-right: 10px;
            color: #CCC;
        }
        
        #command-input {
            flex-grow: 1;
            background: #000;
            color: #0F0;
            border: none;
            font-family: 'Lucida Console', 'Courier New', monospace;
        }
        #command-input:focus {
            outline: none;
        }

        /* --- The new Left-Click Verb Menu --- */
        #context-menu {
            display: none; /* Hidden by default */
            position: absolute;
            background-color: #2c2c2c;
            border: 1px solid #888;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            min-width: 150px;
            z-index: 1000;
        }
        
        #context-menu div {
            padding: 8px 12px;
            color: #DDD;
            cursor: pointer;
            border-bottom: 1px solid #444;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        #context-menu div:last-child {
            border-bottom: none;
        }

        #context-menu div:hover {
            background-color: #4a4a4a;
            color: #FFF;
        }
    </style>
</head>
<body>
    <div id="output">Please enter your character name to create or load a character.</div>
    
    <div id="input-line">
        <span>&gt;</span>
        <input type="text" id="command-input" autofocus>
    </div>

    <div id="context-menu"></div>

    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('command-input');
        const contextMenu = document.getElementById('context-menu');
        
        let activeKeyword = null;
        let playerName = null;
        
        // NEW: We track the game state, sent from the backend
        let currentGameState = "login"; 
        
        // --- NEW: Command History ---
        let commandHistory = [];
        let historyIndex = -1; // -1 means we are at the new, blank command line

        // --- Helper: Send Command to Backend ---
        async function sendCommand(command, name) {
            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_name: name,
                        command: command
                    })
                });
                
                const data = await response.json();
                
                // NEW: Update game state from server response
                if (data.game_state) {
                    currentGameState = data.game_state; // "chargen" or "playing"
                }
                
                // Display the server's response
                if (data.messages) {
                    data.messages.forEach(msg => addMessage(msg));
                }

            } catch (error) {
                addMessage(`Error: Could not connect to server. ${error}`);
            }
        }

        // --- Helper: Add Message to Output (Unchanged) ---
        function addMessage(message, messageClass = null) {
            let formattedMessage = message;
            formattedMessage = formattedMessage.replace(
                /\*\*(.*?)\*\*/g, 
                '<span class="room-title">[$1]</span>'
            );
            if (messageClass) {
                formattedMessage = `<span class="${messageClass}">${formattedMessage}</span>`;
            }
            output.innerHTML += `\n${formattedMessage}`;
            output.scrollTop = output.scrollHeight;
        }

        // --- Input: Listen for "Enter" key ---
        input.addEventListener('keydown', async function(event) {
            if (event.key === 'Enter') {
                const commandOrName = input.value;
                if (!commandOrName) return;

                // --- NEW: Add to history ---
                // Add to history if it's not a duplicate of the last command
                if (playerName && commandOrName !== commandHistory[0]) {
                    commandHistory.unshift(commandOrName); // Adds to the start of the array
                }
                historyIndex = -1; // Reset history position to the blank line
                // --- END NEW ---

                input.value = '';

                if (playerName === null) {
                    // --- 1. This is the LOGIN/CREATE step ---
                    playerName = commandOrName;
                    addMessage(`> Welcome, ${playerName}. Loading character...`, 'command-echo');
                    // Send an automatic 'look' command
                    await sendCommand('look', playerName);
                    
                } else if (currentGameState === "chargen") {
                    // --- 2. This is a CHARGEN answer ---
                    await sendCommand(commandOrName, playerName);
                    
                } else {
                    // --- 3. This is a NORMAL game command ---
                    addMessage(`> ${commandOrName}`, 'command-echo');
                    await sendCommand(commandOrName, playerName);
                }
            }
            // --- NEW: Listen for ArrowUp ---
            else if (event.key === 'ArrowUp') {
                event.preventDefault(); // Stop cursor from moving in the input
                // Check if we have history and we aren't at the end of it
                if (commandHistory.length > 0 && historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[historyIndex];
                }
            }
            // --- NEW: Listen for ArrowDown (for convenience) ---
            else if (event.key === 'ArrowDown') {
                event.preventDefault();
                // Check if we are currently looking at history
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[historyIndex];
                } else if (historyIndex === 0) {
                    // We were at the last command, go back to blank
                    historyIndex = -1;
                    input.value = "";
                }
            }
        });

        // --- NEW: Left-Click Menu ---
        output.addEventListener('click', function(event) {
            const target = event.target;
            
            // Check if we are clicking a keyword
            if (target.classList.contains('keyword')) {
                event.preventDefault(); // Stop default link behavior
                event.stopPropagation(); // !IMPORTANT: Stop click from bubbling to document
                
                const keyword = target.dataset.name || target.innerText;

                if (currentGameState === "chargen") {
                    // --- In chargen, clicking a keyword IS the command ---
                    input.value = ''; // Clear input
                    // We send the text of the keyword as the command
                    sendCommand(target.innerText, playerName); 
                    
                } else if (currentGameState === "playing") {
                    // --- In game, clicking a keyword opens a verb menu ---
                    activeKeyword = keyword;
                    const verbs = (target.dataset.verbs || "look").split(',');
                    
                    contextMenu.innerHTML = ''; // Clear old items
                    
                    verbs.forEach(verb => {
                        const item = document.createElement('div');
                        item.innerText = `${verb} ${activeKeyword}`; // Show as "LOOK FOUNTAIN"
                        item.dataset.command = `${verb} ${activeKeyword}`; // Store as "look fountain"
                        contextMenu.appendChild(item);
                    });

                    // Position and show the menu
                    contextMenu.style.left = `${event.pageX}px`;
                    contextMenu.style.top = `${event.pageY}px`;
                    contextMenu.style.display = 'block';
                }
            }
        });

        // --- REMOVED: The 'contextmenu' (right-click) listener is gone ---


        // --- Hide Menu on any other click ---
        document.addEventListener('click', function(event) {
            // This now only fires if we didn't click a keyword (due to stopPropagation)
            if (contextMenu.style.display === 'block') {
                contextMenu.style.display = 'none';
            }
        });

        // --- Verb Menu: Handle Click on Menu Item ---
        contextMenu.addEventListener('click', function(event) {
            const command = event.target.dataset.command;
            if (command && playerName) { 
                input.value = ''; 
                addMessage(`> ${command}`, 'command-echo'); // Echo the command
                sendCommand(command, playerName); 
            }
        });

    </script>
</body>
</html>